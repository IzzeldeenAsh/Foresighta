<div class="card">
  <div class="card-header">
    <h2 class="page-title">Transactions Management</h2>
  </div>

  <div class="table-container">
    <p-table #dt
      [value]="transactions"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="loadTransactions($event)"
      [loading]="loading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} transactions"
      styleClass="p-datatable-sm p-datatable-striped">

      <ng-template pTemplate="header">
        <tr>
          <th>Type</th>
          <th>Amount</th>
          <th>Date</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-transaction>
        <tr>
          <td>
            <span class="badge" [ngClass]="getTransactionBadgeClass(transaction.transaction)">{{ transaction.transaction | titlecase }}</span>
          </td>
          <td>
            <span [class.text-success]="transaction.amount > 0" [class.text-danger]="transaction.amount < 0">
              {{ transaction.amount > 0 ? '+' : '' }}{{ formatCurrency(transaction.amount) }}
            </span>
          </td>
          <td>{{ formatDate(transaction.date) }}</td>
          <td>
            <span class="badge badge-light-info">{{ getTransactionTypeLabel(transaction.type) | titlecase }}</span>
          </td>
          <td>
            <button pButton
              type="button"
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-info"
              (click)="showTransactionDetails(transaction)"
              pTooltip="View Details">
            </button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">No transactions found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Transaction Details Dialog -->
<p-dialog [(visible)]="displayDialog"
  [modal]="true"
  [style]="{width: '90vw', maxWidth: '1200px'}"
  [maximizable]="true"
  [header]="'Transaction Details'"
  [draggable]="false"
  [resizable]="false"
  styleClass="transaction-details-dialog">

  <div *ngIf="selectedTransaction" class="transaction-details">
    <!-- Header Section with Key Information -->
    <div class="detail-header">
      <div class="header-grid">
        <div class="header-item">
          <i class="pi pi-arrow-up-down header-icon"></i>
          <div class="header-content">
            <span class="header-label">Transaction Type</span>
            <span class="badge" [ngClass]="getTransactionBadgeClass(selectedTransaction.transaction)">{{ selectedTransaction.transaction | titlecase }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-dollar header-icon"></i>
          <div class="header-content">
            <span class="header-label">Amount</span>
            <span class="header-value amount" [class.text-success]="selectedTransaction.amount > 0" [class.text-danger]="selectedTransaction.amount < 0">
              {{ selectedTransaction.amount > 0 ? '+' : '' }}{{ formatCurrency(selectedTransaction.amount) }}
            </span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-calendar header-icon"></i>
          <div class="header-content">
            <span class="header-label">Date</span>
            <span class="header-value">{{ formatDate(selectedTransaction.date) }}</span>
          </div>
        </div>
        <div class="header-item">
          <i class="pi pi-tag header-icon"></i>
          <div class="header-content">
            <span class="header-label">Category</span>
            <span class="badge badge-light-info">{{ getTransactionTypeLabel(selectedTransaction.type) | titlecase }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Insighter Information Section -->
    <div class="insighter-section" *ngIf="selectedTransaction.insighter && shouldShowInsighterInfo(selectedTransaction.type)">
      <h3 class="section-title">
        <i class="pi pi-user"></i>
        Insighter Information
      </h3>

      <div class="insighter-card">
        <!-- Main Profile Header -->
        <div class="profile-header">
          <div class="profile-avatar">
            <img *ngIf="selectedTransaction.insighter.profile_photo_url"
                 [src]="selectedTransaction.insighter.profile_photo_url"
                 [alt]="selectedTransaction.insighter.name"
                 class="avatar-image">
            <div *ngIf="!selectedTransaction.insighter.profile_photo_url"
                 class="avatar-placeholder">
              {{ selectedTransaction.insighter.name.charAt(0) }}
            </div>
          </div>
          <div class="profile-main-info">
            <h4 class="profile-name">{{ selectedTransaction.insighter.name }}</h4>
            <p class="profile-email">{{ selectedTransaction.insighter.email }}</p>
            <div class="profile-id">
              <span class="id-label">ID:</span>
              <span class="id-value">{{ selectedTransaction.insighter.id }}</span>
            </div>
          </div>
          <div class="profile-balance">
            <div class="balance-label">Current Balance</div>
            <div class="balance-amount">{{ formatCurrency(+selectedTransaction.insighter.balance) }}</div>
          </div>
        </div>

        <!-- Profile Details Grid -->
        <div class="profile-details">
          <div class="detail-row">
            <div class="detail-item">
              <i class="pi pi-map-marker detail-icon"></i>
              <div class="detail-content">
                <span class="detail-label">Location</span>
                <span class="detail-value">{{ selectedTransaction.insighter.country || 'Not specified' }}</span>
              </div>
            </div>
            <div class="detail-item">
              <i class="pi pi-phone detail-icon"></i>
              <div class="detail-content">
                <span class="detail-label">Phone</span>
                <span class="detail-value">{{ selectedTransaction.insighter.phone || 'Not provided' }}</span>
              </div>
            </div>
          </div>
          <div class="detail-row">
            <div class="detail-item">
              <i class="pi pi-credit-card detail-icon"></i>
              <div class="detail-content">
                <span class="detail-label">Payment Method</span>
                <span class="badge badge-light-info">{{ selectedTransaction.insighter.payment_type | titlecase }}</span>
              </div>
            </div>
            <div class="detail-item">
              <i class="pi pi-shield detail-icon"></i>
              <div class="detail-content">
                <span class="detail-label">Account Status</span>
                <span class="badge badge-light-success">Active</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Information Section -->
    <div class="items-section" *ngIf="selectedTransaction.order && selectedTransaction.order.sub_orders && selectedTransaction.order.sub_orders.length > 0">
      <h3 class="section-title">
        <i class="pi pi-shopping-cart"></i>
        Related Order Details
      </h3>

      <div class="suborders-container">
        <div class="suborder-card" *ngFor="let suborder of selectedTransaction.order.sub_orders; let i = index">
          <div class="suborder-header">
            <span class="suborder-number">Item Group {{ i + 1 }}</span>
          </div>

          <!-- Knowledge Items -->
          <div class="knowledge-section" *ngIf="suborder.knowledge && suborder.knowledge.length > 0">
            <h4 class="subsection-title">Knowledge Products</h4>
            <div class="knowledge-items">
              <div class="knowledge-item" *ngFor="let item of suborder.knowledge">
                <div class="knowledge-type">
                  <p-chip [label]="item.type" styleClass="custom-chip"></p-chip>
                </div>
                <div class="knowledge-title">{{ item.title }}</div>
              </div>
            </div>
          </div>

          <!-- Documents -->
          <div class="documents-section" *ngIf="suborder.knowledge_documents && suborder.knowledge_documents.length > 0">
            <h4 class="subsection-title">Documents</h4>
            <div class="documents-grid">
              <div *ngFor="let docGroup of suborder.knowledge_documents">
                <div class="document-item" *ngFor="let doc of docGroup">
                  <img [src]="getFileIcon(doc.file_extension)"
                       [alt]="doc.file_extension"
                       class="file-icon">
                  <div class="document-info">
                    <span class="document-name">{{ doc.file_name }}.{{ doc.file_extension }}</span>
                    <span class="document-price">{{ formatCurrency(doc.price) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button pButton type="button" label="Close" icon="pi pi-times" class="p-button-secondary" (click)="displayDialog = false"></button>
    </div>
  </ng-template>
</p-dialog>