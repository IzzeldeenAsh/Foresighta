<!-- Company Management Page -->
<div class="my-company-container">
<div class="card mb-5 mb-xl-10">
  <!-- Header -->
  <div class="card-header border-0 pt-5">
    <h3 class="card-title align-items-start flex-column">
      <span class="card-label fw-bold fs-3 mb-1">{{ 'MY_COMPANY.TITLE' | translate }}</span>
      <span class="text-muted mt-1 fw-semibold fs-7">{{ 'MY_COMPANY.SUBTITLE' | translate }}</span>
    </h3>
    <div class="card-toolbar d-flex align-items-center">
      <!-- View Toggle -->
      <div class="me-3" *ngIf="insighters && insighters.length > 0">
        <div class="btn-group" role="group">
          <button 
            type="button" 
            class="btn btn-sm"
            [class.btn-light-info]="viewMode === 'table'"
            [class.btn-light]="viewMode !== 'table'"
            (click)="toggleViewMode('table')"
            pTooltip="Table View"
            tooltipPosition="top">
            <i class="ki-duotone ki-row-horizontal fs-2">
              <span class="path1"></span>
              <span class="path2"></span>
            </i>
          </button>
          <button 
            type="button" 
            class="btn btn-sm"
            [class.btn-light-info]="viewMode === 'grid'"
            [class.btn-light]="viewMode !== 'grid'"
            (click)="toggleViewMode('grid')"
            pTooltip="Grid View"
            tooltipPosition="top">
            <i class="ki-duotone ki-element-11 fs-2">
              <span class="path1"></span>
              <span class="path2"></span>
              <span class="path3"></span>
              <span class="path4"></span>
            </i>
          </button>
        </div>
      </div>
      
      <button type="button" class="btn btn-sm btn-light-info" (click)="openAddEmployeeModal()">
        <i class="ki-duotone ki-plus fs-2"></i>
        {{ 'MY_COMPANY.ADD_EMPLOYEE' | translate }}
      </button>
    </div>
  </div>
  <!-- Body -->
  <div class="card-body py-3">
    <!-- Empty state - only show if no insighters -->
    <div *ngIf="!loading && (!insighters || insighters.length === 0)" class="d-flex flex-column align-items-center justify-content-center py-8">
      <div class="symbol symbol-200px symbol-circle mb-7">
        <img src="./assets/media/illustrations/sigma-1/5568706.jpg" alt="company image" />
      </div>
      <h2 class="fw-bold text-gray-800">{{ 'MY_COMPANY.ADD_EMPLOYEE' | translate }}</h2>
      <div class="fs-6 mb-5 text-gray-600">
        {{ 'MY_COMPANY.EMPTY_STATE_MESSAGE' | translate }}
      </div>
    </div>
    
    <!-- Insighters Data - only show if there are insighters -->
    <div *ngIf="insighters && insighters.length > 0">
      
      <!-- Table View -->
      <div *ngIf="viewMode === 'table'" class="d-flex justify-content-center align-items-center flex-column">
        <div class="table-container">
          <p-table 
            [value]="insighters" 
            [loading]="loading"
            [paginator]="false"
            [showCurrentPageReport]="false"
            styleClass="p-datatable-sm p-datatable-gridlines"
            [tableStyle]="{'border-collapse': 'separate', 'border-spacing': '0', 'width': '100%'}"
            [rowHover]="true"
            [resizableColumns]="false"
            [scrollable]="false"
            class="company-table">
          
                   <!-- Expand/Collapse Column -->
           <ng-template pTemplate="header">
             <tr>
               <th style="width: 80px; min-width: 80px; text-align: center;">
                 <i class="ki-duotone ki-arrow-down fs-4 text-muted"></i>
               </th>
               <th style="width: 200px; min-width: 200px;">{{ 'MY_COMPANY.TABLE.INSIGHTER' | translate }}</th>
               <th style="width: 200px; min-width: 200px;">{{ 'MY_COMPANY.TABLE.EMAIL' | translate }}</th>
               <th style="width: 120px; min-width: 120px;">{{ 'MY_COMPANY.TABLE.COUNTRY' | translate }}</th>
               <th style="width: 120px; min-width: 120px;">{{ 'MY_COMPANY.TABLE.STATUS' | translate }}</th>
               <!-- <th style="width: 160px; min-width: 160px;">{{ 'MY_COMPANY.TABLE.VERIFICATION' | translate }}</th> -->
               <th style="width: 60px; min-width: 60px; text-align: center;">{{ 'MY_COMPANY.TABLE.ACTIONS' | translate }}</th>
             </tr>
           </ng-template>
          
          <ng-template pTemplate="body" let-insighter>
            <!-- Main Row -->
            <tr [class.expanded-row]="expandedRows[insighter.id]">
                           <!-- Expand/Collapse Button -->
               <td style="text-align: center; width: 80px; min-width: 80px;">
                 <button 
                   type="button" 
                   class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm expand-button" 
                   [ngClass]="{'expanded': expandedRows[insighter.id]}"
                   (click)="expandedRows[insighter.id] = !expandedRows[insighter.id]">
                   <i class="ki-duotone ki-arrow-down fs-2" *ngIf="!expandedRows[insighter.id]">
                     <span class="path1"></span>
                   </i>
                   <i class="ki-duotone ki-arrow-up fs-2" *ngIf="expandedRows[insighter.id]">
                     <span class="path1"></span>
                   </i>
                 </button>
               </td>
              
                           <!-- Insighter Name & Avatar -->
               <td style="width: 220px; min-width: 220px; text-align: start;">
                 <div class="d-flex align-items-center">
                   <div class="symbol symbol-45px me-3">
                     <p-avatar 
                       [label]="getUserInitials(insighter.name)"
                       styleClass="bg-light-primary"
                       [style]="{'font-size': '1rem', 'height': '45px', 'width': '45px'}"
                       *ngIf="!insighter.profile_photo_url">
                     </p-avatar>
                     <img *ngIf="insighter.profile_photo_url" [src]="insighter.profile_photo_url" alt="insighter" class="h-45px w-45px rounded-circle object-fit-cover" style="object-position: top;" />
                   </div>
                   <div class="d-flex flex-column">
                     <span class="text-gray-800 text-hover-primary mb-1 fw-semibold">{{ insighter.name }}</span>
                     <span *ngIf="insighter.id === currentUserId" class="text-info fs-7">
                       {{ 'MY_COMPANY.CURRENT_USER' | translate }}
                     </span>
                   </div>
                 </div>
               </td>
              
                           <!-- Email -->
               <td style="width: 200px; min-width: 200px; text-align: start;">
                 <span class="text-gray-600">{{ insighter.email }}</span>
               </td>
               
               <!-- Country -->
               <td style="width: 140px; min-width: 140px; text-align: start;">
                 <span class="text-gray-600">{{ insighter.country }}</span>
               </td>
               
               <!-- Status -->
               <td style="width: 140px; min-width: 140px; text-align: start;">
                 <span [class]="'badge ' + getStatusBadgeClass(insighter.insighter_status)">
                   {{ 
                       (insighter.insighter_status === 'active' ? 'MY_COMPANY.STATUS.ACTIVE' : 
                        insighter.insighter_status === 'inactive' ? 'MY_COMPANY.STATUS.INACTIVE' : 
                        insighter.insighter_status) | translate | titlecase }}
                 </span>
               </td>
               
               <!-- Verification -->
               <!-- <td style="width: 160px; min-width: 160px; text-align: start;">
                 <span [class]="'badge ' + getVerificationBadgeClass(insighter.verified_as_insighter)">
                   {{ (insighter.verified_as_insighter ? 'MY_COMPANY.VERIFIED' : 'MY_COMPANY.PENDING') | translate }}
                 </span>
               </td> -->
               
               <!-- Actions -->
               <td style="text-align: center; width: 140px; min-width: 140px;">
                 <div class="d-flex justify-content-center gap-1">
                  <button *ngIf="(insighter.roles && insighter.roles.includes('company') && insighter.company && insighter.company.status === 'inactive' || 
                            (!insighter.roles || !insighter.roles.includes('company')) && insighter.insighter_status === 'inactive') 
                            && insighter.id !== currentUserId" 
                          class="btn btn-icon btn-bg-light btn-active-color-success btn-sm"
                          (click)="activateInsighter(insighter.id)" 
                          pTooltip="{{ 'MY_COMPANY.ACTIVATE' | translate }}" 
                          tooltipPosition="top">
                    <i class="ki-duotone ki-check fs-2"></i>
                  </button>
                  <button *ngIf="(insighter.roles && insighter.roles.includes('company') && insighter.company && insighter.company.status === 'active' || 
                            (!insighter.roles || !insighter.roles.includes('company')) && insighter.insighter_status === 'active' && insighter.verified_as_insighter)   
                            && insighter.id !== currentUserId" 
                          class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm"
                          (click)="deactivateInsighter(insighter.id)" 
                          pTooltip="{{ 'MY_COMPANY.DEACTIVATE' | translate }}" 
                          tooltipPosition="top">
                    <i class="ki-duotone ki-shield-slash fs-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                      <span class="path3"></span>
                      <span class="path4"></span>
                    </i>
                  </button>
                  <button *ngIf="insighter.id !== currentUserId" 
                          class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm"
                          (click)="deleteInsighter(insighter.id)" 
                          pTooltip="{{ 'MY_COMPANY.DELETE' | translate }}" 
                          tooltipPosition="top">
                    <i class="ki-duotone ki-trash fs-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                      <span class="path3"></span>
                      <span class="path4"></span>
                      <span class="path5"></span>
                    </i>
                  </button>
                </div>
              </td>
            </tr>
            
            <!-- Expanded Row for Knowledge Statistics -->
            <tr *ngIf="expandedRows[insighter.id]" class="expanded-row">
              <td colspan="7">
                <div class="px-4 py-4 rounded my-3 statistics-container">
                  <!-- Header with user name and total count -->
                  <div class="d-flex align-items-center justify-content-between mb-4">
                    <h5 class="fw-bolder m-0">
                      <i class="fas fa-chart-bar text-primary me-2"></i>
                      {{ 'MY_COMPANY.PUBLISHED_KNOWLEDGE' | translate:{ name: insighter.name } }}
                    </h5>
                    <span class="badge badge-light-primary px-3 py-2 fs-7" *ngIf="getTotalKnowledgeCount(insighter)">
                      {{ 'MY_COMPANY.TOTAL' | translate }}: {{ getTotalKnowledgeCount(insighter) }}
                    </span>
                  </div>
                  
                  <!-- Statistics cards -->
                  <div class="row g-3">
                    <div *ngIf="insighter.knowledge_type_statistics?.report !== undefined" class="col-6 col-sm-4 col-md-3 col-xl-2">
                      <div class="knowledge-stat report">
                        <svg width="28" height="28" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path opacity="0.4" d="M41.515 20.01L39.6367 28.0217C38.0267 34.9409 34.845 37.7392 28.865 37.1642C27.9067 37.0875 26.8717 36.915 25.76 36.6467L22.54 35.88C14.5475 33.9825 12.075 30.0342 13.9533 22.0225L15.8317 13.9917C16.215 12.3625 16.675 10.9442 17.25 9.77504C19.4925 5.1367 23.3067 3.89087 29.7083 5.40504L32.9092 6.15254C40.94 8.03087 43.3933 11.9984 41.515 20.01Z" fill="#699DDE"/>
                          <path d="M28.865 37.1642C27.6767 37.9692 26.1817 38.64 24.3608 39.2342L21.3325 40.2309C13.7233 42.6842 9.71748 40.6334 7.24498 33.0242L4.79165 25.4534C2.33832 17.8442 4.36998 13.8192 11.9791 11.3659L15.0075 10.3692C15.7933 10.12 16.5408 9.90919 17.25 9.77502C16.675 10.9442 16.215 12.3625 15.8316 13.9917L13.9533 22.0225C12.075 30.0342 14.5475 33.9825 22.54 35.88L25.76 36.6467C26.8716 36.915 27.9067 37.0875 28.865 37.1642Z" fill="#009EF7"/>
                          <path d="M33.5225 20.1442C33.4075 20.1442 33.2925 20.1251 33.1583 20.1059L23.8625 17.7484C23.0958 17.5567 22.6358 16.7709 22.8275 16.0042C23.0192 15.2376 23.805 14.7776 24.5717 14.9692L33.8675 17.3267C34.6342 17.5184 35.0942 18.3042 34.9025 19.0709C34.7492 19.7034 34.155 20.1442 33.5225 20.1442Z" fill="white"/>
                          <path d="M27.9067 26.6225C27.7917 26.6225 27.6767 26.6034 27.5425 26.5842L21.965 25.1659C21.1983 24.9742 20.7383 24.1884 20.93 23.4217C21.1217 22.655 21.9075 22.195 22.6742 22.3867L28.2517 23.805C29.0183 23.9967 29.4783 24.7825 29.2867 25.5492C29.1333 26.2009 28.5583 26.6225 27.9067 26.6225Z" fill="white"/>
                        </svg>
                        <div class="stat-label">Reports</div>
                        <div class="stat-value">{{ insighter.knowledge_type_statistics?.report || 0 }}</div>
                      </div>
                    </div>
                    <div *ngIf="insighter.knowledge_type_statistics?.data !== undefined" class="col-6 col-sm-4 col-md-3 col-xl-2">
                      <div class="knowledge-stat data">
                        <svg width="24" height="26" viewBox="0 0 26 29" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12.5596 0C9.13931 0 5.92618 0.608334 3.51251 1.71279C1.28038 2.73511 0 4.08721 0 5.42527C0 6.76332 1.28038 8.11584 3.51251 9.13766C5.92618 10.2421 9.13923 10.8504 12.5596 10.8504C15.98 10.8504 19.1935 10.2421 21.6064 9.13766C23.8388 8.11584 25.1196 6.7634 25.1196 5.42527C25.1196 4.08713 23.8388 2.73511 21.6064 1.71279C19.1931 0.608334 15.9799 0 12.5596 0Z" fill="black"/>
                          <path d="M0 8.1631C0.70931 8.93133 1.72436 9.627 3.01754 10.2193C5.58309 11.3931 8.97215 12.0398 12.56 12.0398C16.1479 12.0398 19.5365 11.3927 22.1021 10.2193C23.3953 9.627 24.4103 8.93158 25.1196 8.1631V11.6126C25.1196 12.9547 23.8416 14.3088 21.614 15.3283C19.2055 16.43 15.99 17.0375 12.5596 17.0375C9.12923 17.0375 5.91329 16.43 3.50532 15.3283C1.27757 14.3088 0 12.9547 0 11.6126V8.1631Z" fill="black"/>
                          <path d="M25.1196 14.3506C22.9929 16.656 18.2281 18.2269 12.5596 18.2269C6.89107 18.2269 2.12636 16.656 0 14.3506V17.3878C0 18.729 1.27757 20.084 3.50532 21.1034C5.91329 22.2054 9.12923 22.813 12.5596 22.813C15.99 22.813 19.2055 22.2054 21.6144 21.1034C23.8421 20.084 25.1196 18.729 25.1196 17.3878V14.3506Z" fill="black"/>
                          <path d="M3.50532 27.2908C1.27757 26.2713 0 24.9165 0 23.5748V20.1256C2.12636 22.4314 6.89107 24.0024 12.5596 24.0024C18.2281 24.0024 22.9929 22.4314 25.1196 20.1256V23.5748C25.1196 24.9165 23.8416 26.2713 21.614 27.2908C19.2055 28.3929 15.99 29 12.5596 29C9.12923 29 5.91329 28.3929 3.50532 27.2908Z" fill="black"/>
                        </svg>
                        <div class="stat-label">Data</div>
                        <div class="stat-value">{{ insighter.knowledge_type_statistics?.data || 0 }}</div>
                      </div>
                    </div>
                    <div *ngIf="insighter.knowledge_type_statistics?.insight !== undefined" class="col-6 col-sm-4 col-md-3 col-xl-2">
                      <div class="knowledge-stat insight">
                        <svg width="26" height="26" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M22.0048 0C27.6547 0 31 3.34532 31 8.9952V22.0048C31 27.6547 27.6547 31 22.0048 31H8.9952C3.34532 31 0 27.5803 0 21.9305V8.9952C0 3.34532 3.34532 0 8.9952 0H22.0048ZM8.84652 15.9832C7.95444 15.9832 7.28537 16.6523 7.28537 17.5444V21.9305C7.28537 22.8225 7.95444 23.4916 8.84652 23.4916C9.73861 23.4916 10.4077 22.8225 10.4077 21.9305V17.5444C10.4077 16.6523 9.73861 15.9832 8.84652 15.9832ZM14.8681 9.06954C13.976 9.06954 13.307 9.73861 13.307 10.6307V21.9305C13.307 22.8225 13.976 23.4916 14.8681 23.4916C15.7602 23.4916 16.4293 22.8225 16.4293 21.9305V10.6307C16.4293 9.73861 15.7602 9.06954 14.8681 9.06954ZM20.5923 6.54197C19.7002 6.54197 18.9568 7.35971 18.9568 8.40048V21.5588C18.9568 22.5995 19.7002 23.4173 20.5923 23.4173C21.4844 23.4173 22.2278 22.5995 22.2278 21.5588V8.40048C22.2278 7.35971 21.4844 6.54197 20.5923 6.54197Z" fill="#16C653"/>
                        </svg>
                        <div class="stat-label">Insights</div>
                        <div class="stat-value">{{ insighter.knowledge_type_statistics?.insight || 0 }}</div>
                      </div>
                    </div>
                    <div *ngIf="insighter.knowledge_type_statistics?.manual !== undefined" class="col-6 col-sm-4 col-md-3 col-xl-2">
                      <div class="knowledge-stat manual">
                        <svg width="28" height="28" viewBox="0 0 37 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M31.6042 10.7916V23.125H9.78958C7.36916 23.125 5.39583 25.0983 5.39583 27.5187V10.7916C5.39583 4.62498 6.93749 3.08331 13.1042 3.08331H23.8958C30.0625 3.08331 31.6042 4.62498 31.6042 10.7916Z" fill="#F6C001"/>
                          <path d="M31.6042 23.125V28.5208C31.6042 31.4963 29.1837 33.9167 26.2083 33.9167H10.7917C7.81624 33.9167 5.39583 31.4963 5.39583 28.5208V27.5188C5.39583 25.0983 7.36916 23.125 9.78958 23.125H31.6042Z" fill="#FFDEB2"/>
                          <path d="M24.6667 11.9479H12.3333C11.7012 11.9479 11.1771 11.4238 11.1771 10.7917C11.1771 10.1596 11.7012 9.63544 12.3333 9.63544H24.6667C25.2987 9.63544 25.8229 10.1596 25.8229 10.7917C25.8229 11.4238 25.2987 11.9479 24.6667 11.9479Z" fill="white"/>
                          <path d="M20.0417 17.3437H12.3333C11.7012 17.3437 11.1771 16.8196 11.1771 16.1875C11.1771 15.5554 11.7012 15.0312 12.3333 15.0312H20.0417C20.6737 15.0312 21.1979 15.5554 21.1979 16.1875C21.1979 16.8196 20.6737 17.3437 20.0417 17.3437Z" fill="white"/>
                        </svg>
                        <div class="stat-label">Manuals</div>
                        <div class="stat-value">{{ insighter.knowledge_type_statistics?.manual || 0 }}</div>
                      </div>
                    </div>
                    <div *ngIf="insighter.knowledge_type_statistics?.course !== undefined" class="col-6 col-sm-4 col-md-3 col-xl-2">
                      <div class="knowledge-stat course">
                        <svg width="26" height="26" viewBox="0 0 39 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M31.9898 26.8163C31.9898 24.1788 29.8518 22.0408 27.2143 22.0408C24.5767 22.0408 22.4388 24.1788 22.4388 26.8163C22.4388 28.1696 23.0037 29.3885 23.9081 30.2576V36L27.2143 33.7959L30.5204 36V30.2576C31.4248 29.3885 31.9898 28.1696 31.9898 26.8163Z" fill="#C3D8F2"/>
                          <path d="M37.1327 0H1.86734C1.05624 0 0.397949 0.657551 0.397949 1.46939V30.8572C0.397949 31.6683 1.05624 32.3265 1.86734 32.3265H20.9694V31.3443C20.0143 30.0372 19.5 28.4694 19.5 26.8163C19.5 22.5625 22.9604 19.102 27.2143 19.102C31.4682 19.102 34.9286 22.5625 34.9286 26.8163C34.9286 28.4701 34.4143 30.038 33.4592 31.345V32.3265H37.1327C37.9438 32.3265 38.6021 31.6683 38.6021 30.8572V1.46939C38.6021 0.657551 37.9438 0 37.1327 0ZM20.9694 13.2245H8.47959V10.2857H20.9694V13.2245ZM30.5204 7.34694H8.47959V4.40816H30.5204V7.34694Z" fill="#0ABB87"/>
                        </svg>
                        <div class="stat-label">Courses</div>
                        <div class="stat-value">{{ insighter.knowledge_type_statistics?.course || 0 }}</div>
                      </div>
                    </div>
                    
                    <!-- If no statistics are available -->
                    <div *ngIf="!insighter.knowledge_type_statistics || getTotalKnowledgeCount(insighter) === 0" class="col-12 text-center py-4">
                      <div class="d-flex flex-column align-items-center">
                        <i class="fas fa-folder-open text-muted fs-2x mb-3"></i>
                        <span class="text-muted fs-6">No knowledge published yet by this insighter</span>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>
          
          <!-- Empty Message -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="d-flex flex-column align-items-center">
                  <i class="fas fa-users text-muted fs-2x mb-3"></i>
                  <span class="text-muted fs-6">{{ 'MY_COMPANY.NO_EMPLOYEES' | translate }}</span>
                </div>
              </td>
            </tr>
                   </ng-template>
         </p-table>
        </div>
        
        <!-- Pagination for Table View -->
        <div class="d-flex justify-content-between align-items-center flex-wrap mt-4">
          <div class="d-flex flex-wrap py-2">
            <p-paginator 
              [rows]="rows" 
              [totalRecords]="totalRecords" 
              [first]="first"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="{{ 'MY_COMPANY.SHOWING_ENTRIES' | translate:{first: '{first}', last: '{last}', total: '{totalRecords}'} }}"
              (onPageChange)="onPageChange($event)">
            </p-paginator>
          </div>
        </div>
      </div>
      
      <!-- Grid View -->
      <div *ngIf="viewMode === 'grid'" class="grid-view">
        <div class="row g-4">
          <div *ngFor="let insighter of insighters" class="col-xl-4 col-lg-6 col-md-6">
            <div class="card insighter-card h-100">
              <div class="card-body d-flex flex-column position-relative">
                <!-- Status Badge - Top Right -->
                <div class="position-absolute" style="top: 16px; right: 16px;">
                  <span [class]="'badge ' + getStatusBadgeClass(insighter.insighter_status)">
                    {{ 
                        (insighter.insighter_status === 'active' ? 'MY_COMPANY.STATUS.ACTIVE' : 
                         insighter.insighter_status === 'inactive' ? 'MY_COMPANY.STATUS.INACTIVE' : 
                         insighter.insighter_status) | translate | titlecase }}
                  </span>
                </div>
                
                <!-- Header -->
                <div class="d-flex align-items-center mb-4">
                  <div class="symbol symbol-50px me-3">
                    <p-avatar 
                      [label]="getUserInitials(insighter.name)"
                      styleClass="bg-light-info"
                      [style]="{'font-size': '1.1rem', 'height': '50px', 'width': '50px'}"
                      *ngIf="!insighter.profile_photo_url">
                    </p-avatar>
                    <img 
                      *ngIf="insighter.profile_photo_url" 
                      [src]="insighter.profile_photo_url" 
                      alt="insighter" 
                      class="h-50px w-50px rounded-circle object-fit-cover" 
                      style="object-position: top;" />
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="card-title mb-1 text-gray-800 fw-bold">{{ insighter.name }}</h5>
                    <div class="text-muted fs-7" *ngIf="insighter.id === currentUserId">
                      {{ 'MY_COMPANY.CURRENT_USER' | translate }}
                    </div>
                  </div>
                </div>
                
                <!-- Email and Country -->
                <div class="mb-4 flex-grow-1">
                  <div class="d-flex align-items-center mb-2">
                    <i class="ki-duotone ki-sms fs-4 text-muted me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    <span class="text-gray-600 fs-7">{{ insighter.email }}</span>
                  </div>
                  <div class="d-flex align-items-center mb-3">
                    <i class="ki-duotone ki-geolocation fs-4 text-muted me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    <span class="text-gray-600 fs-7">{{ insighter.country || 'N/A' }}</span>
                  </div>
                  
                  <!-- Knowledge Stats Summary -->
                  <div class="knowledge-summary" *ngIf="getTotalKnowledgeCount(insighter) > 0">
                    <div class="text-inline-start mb-3">
                      <span class="text-muted fs-8">{{ 'MY_COMPANY.PUBLISHED_KNOWLEDGE' | translate:{ name: insighter.name } }}</span>
                    </div>
                    <div class="knowledge-big-stats d-flex justify-content-start gap-3">
                      <div *ngIf="insighter.knowledge_type_statistics?.report" 
                           class="big-stat-item text-center"
                           pTooltip="{{ 'KNOWLEDGE_TYPES.REPORT' | translate }}"
                           tooltipPosition="top"
                           [showDelay]="300">
                        <svg width="24" height="24" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-1">
                          <path opacity="0.4" d="M45.125 21.75L43.0833 30.4583C41.3333 37.9792 37.875 41.0208 31.375 40.3958C30.3333 40.3125 29.2083 40.125 28 39.8333L24.5 39C15.8125 36.9375 13.125 32.6458 15.1667 23.9375L17.2083 15.2083C17.625 13.4375 18.125 11.8958 18.75 10.625C21.1875 5.58333 25.3333 4.22916 32.2917 5.875L35.7708 6.6875C44.5 8.72916 47.1667 13.0417 45.125 21.75Z" fill="#589AEA"/>
                          <path d="M31.375 40.3958C30.0833 41.2708 28.4583 42 26.4792 42.6458L23.1875 43.7292C14.9167 46.3958 10.5625 44.1667 7.87499 35.8958L5.20833 27.6667C2.54166 19.3958 4.74999 15.0208 13.0208 12.3542L16.3125 11.2708C17.1667 11 17.9792 10.7708 18.75 10.625C18.125 11.8958 17.625 13.4375 17.2083 15.2083L15.1667 23.9375C13.125 32.6458 15.8125 36.9375 24.5 39L28 39.8333C29.2083 40.125 30.3333 40.3125 31.375 40.3958Z" fill="#589AEA"/>
                        </svg>
                        <div class="stat-number fw-bold fs-5 text-info">{{ insighter.knowledge_type_statistics?.report }}</div>
                      </div>
                      <div *ngIf="insighter.knowledge_type_statistics?.data" 
                           class="big-stat-item text-center"
                           pTooltip="{{ 'KNOWLEDGE_TYPES.DATA' | translate }}"
                           tooltipPosition="top"
                           [showDelay]="300">
                        <svg width="24" height="24" viewBox="0 0 30 34" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-1">
                          <path d="M14.5464 0C10.5851 0 6.86364 0.704566 4.06815 1.98373C1.48292 3.16777 0 4.73376 0 6.28348C0 7.8332 1.48292 9.39967 4.06815 10.5831C6.86364 11.8623 10.585 12.5669 14.5464 12.5669C18.5078 12.5669 22.2297 11.8623 25.0243 10.5831C27.6099 9.39967 29.0933 7.8333 29.0933 6.28348C29.0933 4.73367 27.6099 3.16777 25.0243 1.98373C22.2293 0.704566 18.5077 0 14.5464 0Z" fill="#589AEA"/>
                          <path d="M0 9.45442C0.821516 10.3442 1.99713 11.1499 3.49489 11.8359C6.46628 13.1954 10.3914 13.9444 14.5469 13.9444C18.7023 13.9444 22.627 13.1949 25.5984 11.8359C27.0961 11.1499 28.2718 10.3445 29.0933 9.45442V13.4496C29.0933 15.004 27.6131 16.5723 25.0331 17.7531C22.2436 19.029 18.5194 19.7326 14.5464 19.7326C10.5734 19.7326 6.84871 19.029 4.05982 17.7531C1.47967 16.5723 0 15.004 0 13.4496V9.45442Z" fill="#589AEA"/>
                          <path d="M29.0933 16.6207C26.6302 19.2908 21.1116 21.1102 14.5464 21.1102C7.98116 21.1102 2.46273 19.2908 0 16.6207V20.1383C0 21.6918 1.47967 23.261 4.05982 24.4417C6.84871 25.7181 10.5734 26.4217 14.5464 26.4217C18.5194 26.4217 22.2436 25.7181 25.0336 24.4417C27.6136 23.261 29.0933 21.6918 29.0933 20.1383V16.6207Z" fill="#589AEA"/>
                          <path d="M4.05982 31.608C1.47967 30.4272 0 28.858 0 27.3041V23.3093C2.46273 25.9799 7.98116 27.7994 14.5464 27.7994C21.1116 27.7994 26.6302 25.9799 29.0933 23.3093V27.3041C29.0933 28.858 27.6131 30.4272 25.0331 31.608C22.2436 32.8844 18.5194 33.5875 14.5464 33.5875C10.5734 33.5875 6.84871 32.8844 4.05982 31.608Z" fill="#589AEA"/>
                        </svg>
                        <div class="stat-number fw-bold fs-5 text-info ">{{ insighter.knowledge_type_statistics?.data }}</div>
                      </div>
                      <div *ngIf="insighter.knowledge_type_statistics?.insight" 
                           class="big-stat-item text-center"
                           pTooltip="{{ 'KNOWLEDGE_TYPES.INSIGHT' | translate }}"
                           tooltipPosition="top"
                           [showDelay]="300">
                        <svg width="24" height="24" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-1">
                          <path d="M29.5625 0C37.1458 0 41.6663 4.52116 41.6455 12.1045V29.5625C41.6455 37.1457 37.1251 41.6669 29.542 41.667H12.1045C4.52127 41.667 0.00012927 37.146 0 29.542V12.1045C0 4.52116 4.52116 0 12.1045 0H29.5625ZM11.9346 21.46C10.7753 21.4601 9.83305 22.4022 9.83301 23.5615V29.4678C9.83321 30.6269 10.7754 31.5682 11.9346 31.5684C13.112 31.5684 14.0545 30.627 14.0547 29.4678V23.5615C14.0546 22.4021 13.1121 21.46 11.9346 21.46ZM19.96 12.1846C18.7825 12.1847 17.8409 13.1268 17.8408 14.2861V29.4678C17.841 30.6269 18.7827 31.5682 19.96 31.5684C21.1192 31.5684 22.0613 30.627 22.0615 29.4678V14.2861C22.0615 13.1267 21.1194 12.1846 19.96 12.1846ZM27.6689 8.83301C26.4561 8.83301 25.4854 9.93196 25.4854 11.2842V28.9912C25.4855 30.3434 26.4561 31.4424 27.6689 31.4424C28.863 31.4423 29.8329 30.3433 29.833 28.9912V11.2842C29.8329 9.93204 28.8631 8.83313 27.6689 8.83301Z" fill="#589AEA"/>
                        </svg>
                        <div class="stat-number fw-bold fs-5 text-info">{{ insighter.knowledge_type_statistics?.insight }}</div>
                      </div>
                      <div *ngIf="insighter.knowledge_type_statistics?.manual" 
                           class="big-stat-item text-center"
                           pTooltip="{{ 'KNOWLEDGE_TYPES.MANUAL' | translate }}"
                           tooltipPosition="top"
                           [showDelay]="300">
                        <svg width="24" height="24" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-1">
                          <path d="M42.7083 14.5834V31.25H13.2292C9.95834 31.25 7.29167 33.9167 7.29167 37.1875V14.5834C7.29167 6.25002 9.37501 4.16669 17.7083 4.16669H32.2917C40.625 4.16669 42.7083 6.25002 42.7083 14.5834Z" fill="#589AEA"/>
                          <path d="M42.7083 31.25V38.5417C42.7083 42.5625 39.4375 45.8333 35.4167 45.8333H14.5833C10.5625 45.8333 7.29167 42.5625 7.29167 38.5417V37.1875C7.29167 33.9167 9.95834 31.25 13.2292 31.25H42.7083Z" fill="#589AEA"/>
                          <path d="M33.3333 16.1458H16.6667C15.8125 16.1458 15.1042 15.4375 15.1042 14.5833C15.1042 13.7291 15.8125 13.0208 16.6667 13.0208H33.3333C34.1875 13.0208 34.8958 13.7291 34.8958 14.5833C34.8958 15.4375 34.1875 16.1458 33.3333 16.1458Z" fill="#0179FE"/>
                          <path d="M27.0833 23.4375H16.6667C15.8125 23.4375 15.1042 22.7292 15.1042 21.875C15.1042 21.0208 15.8125 20.3125 16.6667 20.3125H27.0833C27.9375 20.3125 28.6458 21.0208 28.6458 21.875C28.6458 22.7292 27.9375 23.4375 27.0833 23.4375Z" fill="#0179FE"/>
                        </svg>
                        <div class="stat-number fw-bold fs-5 text-info ">{{ insighter.knowledge_type_statistics?.manual }}</div>
                      </div>
                      <div *ngIf="insighter.knowledge_type_statistics?.course" 
                           class="big-stat-item text-center"
                           pTooltip="{{ 'KNOWLEDGE_TYPES.COURSE' | translate }}"
                           tooltipPosition="top"
                           [showDelay]="300">
                        <svg width="24" height="24" viewBox="0 0 39 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-1">
                          <path d="M31.9898 26.8163C31.9898 24.1788 29.8518 22.0408 27.2143 22.0408C24.5767 22.0408 22.4388 24.1788 22.4388 26.8163C22.4388 28.1696 23.0037 29.3885 23.9081 30.2576V36L27.2143 33.7959L30.5204 36V30.2576C31.4248 29.3885 31.9898 28.1696 31.9898 26.8163Z" fill="#589AEA"/>
                          <path d="M37.1327 0H1.86734C1.05624 0 0.397949 0.657551 0.397949 1.46939V30.8572C0.397949 31.6683 1.05624 32.3265 1.86734 32.3265H20.9694V31.3443C20.0143 30.0372 19.5 28.4694 19.5 26.8163C19.5 22.5625 22.9604 19.102 27.2143 19.102C31.4682 19.102 34.9286 22.5625 34.9286 26.8163C34.9286 28.4701 34.4143 30.038 33.4592 31.345V32.3265H37.1327C37.9438 32.3265 38.6021 31.6683 38.6021 30.8572V1.46939C38.6021 0.657551 37.9438 0 37.1327 0ZM20.9694 13.2245H8.47959V10.2857H20.9694V13.2245ZM30.5204 7.34694H8.47959V4.40816H30.5204V7.34694Z" fill="#589AEA"/>
                        </svg>
                        <div class="stat-number fw-bold fs-5 text-info">{{ insighter.knowledge_type_statistics?.course }}</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Actions -->
                <div class="card-actions mt-auto">
                  <div class="d-flex justify-content-center gap-2">
                    <button *ngIf="(insighter.roles && insighter.roles.includes('company') && insighter.company && insighter.company.status === 'inactive' || 
                              (!insighter.roles || !insighter.roles.includes('company')) && insighter.insighter_status === 'inactive') 
                              && insighter.id !== currentUserId" 
                            class="btn btn-sm btn-success"
                            (click)="activateInsighter(insighter.id)" 
                            pTooltip="{{ 'MY_COMPANY.ACTIVATE' | translate }}" 
                            tooltipPosition="top">
                      <i class="ki-duotone ki-check fs-4">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                      {{ 'MY_COMPANY.ACTIVATE' | translate }}
                    </button>
                    <button *ngIf="(insighter.roles && insighter.roles.includes('company') && insighter.company && insighter.company.status === 'active' || 
                              (!insighter.roles || !insighter.roles.includes('company')) && insighter.insighter_status === 'active' && insighter.verified_as_insighter)   
                              && insighter.id !== currentUserId" 
                            class="btn btn-sm btn-light-warning"
                            (click)="deactivateInsighter(insighter.id)" 
                            pTooltip="{{ 'MY_COMPANY.DEACTIVATE' | translate }}" 
                            tooltipPosition="top">
                      <i class="ki-duotone ki-shield-slash fs-4">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                      </i>
                      {{ 'MY_COMPANY.DEACTIVATE' | translate }}
                    </button>
                    <button *ngIf="insighter.id !== currentUserId" 
                            class="btn btn-sm btn-light-danger"
                            (click)="deleteInsighter(insighter.id)" 
                            pTooltip="{{ 'MY_COMPANY.DELETE' | translate }}" 
                            tooltipPosition="top">
                      <i class="ki-duotone ki-trash fs-4">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                        <span class="path5"></span>
                      </i>
                      {{ 'MY_COMPANY.DELETE' | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Pagination for Grid View -->
        <div class="d-flex justify-content-between align-items-center flex-wrap mt-4">
          <div class="d-flex flex-wrap py-2">
            <p-paginator 
              [rows]="rows" 
              [totalRecords]="totalRecords" 
              [first]="first"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="{{ 'MY_COMPANY.SHOWING_ENTRIES' | translate:{first: '{first}', last: '{last}', total: '{totalRecords}'} }}"
              (onPageChange)="onPageChange($event)">
            </p-paginator>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Employee Modal -->
<p-dialog 
  [(visible)]="displayAddEmployeeModal" 
  [style]="{width: '800px'}" 
  [header]="'MY_COMPANY.ADD_EMPLOYEE' | translate" 
  [modal]="true" 
  [draggable]="false" 
  [resizable]="false"
  appendTo="body"
  [closeOnEscape]="true"
  (onHide)="closeAddEmployeeModal()"
  >
  
  <!-- Add a container with fixed height -->
  <div class="modal-content-container" style="min-height: 400px; max-height: 520px; overflow-y: auto;">
    <!-- Email input form -->
    <div class="mb-5">
      <form [formGroup]="emailForm">
        <div class="mb-3">
          <label class="form-label required">{{ 'MY_COMPANY.EMAIL_ADDRESS' | translate }}</label>
          <div class="input-group" dir="ltr">
            <input 
              type="email" 
              class="form-control text-start" 
              [placeholder]="'MY_COMPANY.ENTER_EMAIL' | translate" 
              formControlName="email"
              pInputText
              dir="ltr"
            />
            <span class="input-group-text">
              <i class="ki-duotone ki-sms fs-4">
                <span class="path1"></span>
                <span class="path2"></span>
              </i>
            </span>
          </div>
          <!-- Validation messages -->
          <div *ngIf="emailForm.get('email')?.touched" class="text-end">
            <div *ngIf="emailForm.get('email')?.hasError('required')" class="fv-plugins-message-container">
              <div class="fv-help-block">{{ 'MY_COMPANY.EMAIL_REQUIRED' | translate }}</div>
            </div>
            <div *ngIf="emailForm.get('email')?.hasError('email')" class="fv-plugins-message-container">
              <div class="fv-help-block">{{ 'MY_COMPANY.EMAIL_INVALID' | translate }}</div>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Empty state illustration - show when nothing else is displayed -->
    <div *ngIf="!isCheckingAccount && !accountExistError && 
               !(accountExists && accountInfo) && 
               !(emailForm.get('email')?.valid && emailForm.get('email')?.dirty && apiCheckCompleted)" 
          class="d-flex flex-column align-items-center justify-content-center my-10">
      <img src="./assets/media/illustrations/employee_search.svg" alt="Search employees" style="max-width: 300px;" />
      <div class="text-muted fs-6 mt-4 text-center">Enter an email address to search for existing account or create new employee</div>
    </div>
    
    <!-- Processing indicator -->
    <div *ngIf="isCheckingAccount" class="d-flex justify-content-center mb-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'MY_COMPANY.LOADING' | translate }}</span>
      </div>
      <span class="ms-2">{{ 'MY_COMPANY.CHECKING_ACCOUNT' | translate }}</span>
    </div>
    
    <!-- Error message -->
    <div *ngIf="accountExistError" class="alert alert-danger mb-5">
      {{ accountExistError }}
    </div>
    
    <!-- Account exists - show user info -->
    <div *ngIf="accountExists && accountInfo && !accountExistError && !isCheckingAccount" class="mb-5">
      <div class="d-flex flex-center my-10 mb-5">
          <div class="symbol symbol-60px symbol-circle me-3">
            <p-avatar 
              [label]="getUserInitials(accountInfo.name)"
              styleClass="bg-light-info"
              size="large"
              [style]="{'font-size': '1.2rem', 'height': '40px', 'width': '40px'}">
            </p-avatar>
          </div>
          <div class="d-flex flex-column">
            <span class="fs-4 fw-bold text-gray-800 mb-0">{{ accountInfo.name }}</span>
            <span class="fs-6 fw-semibold text-muted">{{ accountInfo.email }}</span>
          </div>
        </div>
        
        <!-- Country field for existing account (only show if country_id is null) -->
        <form [formGroup]="employeeForm" *ngIf="!accountInfo.country_id">
          <div class="mb-3">
            <label class="form-label required">{{ 'MY_COMPANY.COUNTRY' | translate }}</label>
            <app-country-dropdown
              [countries]="availableCountries"
              [placeholder]="'MY_COMPANY.SELECT_COUNTRY' | translate"
              [searchPlaceholder]="'MY_COMPANY.SEARCH_COUNTRIES' | translate"
              [enableSearch]="true"
              [showClear]="true"
              [lang]="lang"
              [isInvalid]="!!(employeeForm.get('country')?.touched && employeeForm.get('country')?.invalid)"
              formControlName="country"
  >
            </app-country-dropdown>
            <!-- Validation messages -->
            <div *ngIf="employeeForm.get('country')?.touched && employeeForm.get('country')?.hasError('required')" class="fv-plugins-message-container">
              <div class="fv-help-block">{{ 'MY_COMPANY.COUNTRY_REQUIRED' | translate }}</div>
            </div>
          </div>
        </form>
    </div>
    
    <!-- Account doesn't exist - show create form -->
    <div *ngIf="!accountExists && !accountExistError && !isCheckingAccount && emailForm.get('email')?.valid && emailForm.get('email')?.dirty && apiCheckCompleted" class="mb-5">
      <form [formGroup]="employeeForm">
        <!-- First Name -->
        <div class="mb-3">
          <label class="form-label required">{{ 'MY_COMPANY.FIRST_NAME' | translate }}</label>
          <input 
            type="text" 
            class="form-control" 
            [placeholder]="'MY_COMPANY.ENTER_FIRST_NAME' | translate" 
            formControlName="firstName"
            pInputText
          />
          <!-- Validation messages -->
          <div *ngIf="employeeForm.get('firstName')?.touched && employeeForm.get('firstName')?.hasError('required')" class="fv-plugins-message-container">
            <div class="fv-help-block">{{ 'MY_COMPANY.FIRST_NAME_REQUIRED' | translate }}</div>
          </div>
        </div>
        
        <!-- Last Name -->
        <div class="mb-3">
          <label class="form-label required">{{ 'MY_COMPANY.LAST_NAME' | translate }}</label>
          <input 
            type="text" 
            class="form-control" 
            [placeholder]="'MY_COMPANY.ENTER_LAST_NAME' | translate" 
            formControlName="lastName"
            pInputText
          />
          <!-- Validation messages -->
          <div *ngIf="employeeForm.get('lastName')?.touched && employeeForm.get('lastName')?.hasError('required')" class="fv-plugins-message-container">
            <div class="fv-help-block">{{ 'MY_COMPANY.LAST_NAME_REQUIRED' | translate }}</div>
          </div>
        </div>
        
        <!-- Country -->
        <div class="mb-3">
          <label class="form-label required">{{ 'MY_COMPANY.COUNTRY' | translate }}</label>
          <app-country-dropdown
            [countries]="availableCountries"
            [placeholder]="'MY_COMPANY.SELECT_COUNTRY' | translate"
            [searchPlaceholder]="'MY_COMPANY.SEARCH_COUNTRIES' | translate"
            [enableSearch]="true"
            [showClear]="true"
            [lang]="lang"
            [isInvalid]="!!(employeeForm.get('country')?.touched && employeeForm.get('country')?.invalid)"
            formControlName="country"
>
          </app-country-dropdown>
          <!-- Validation messages -->
          <div *ngIf="employeeForm.get('country')?.touched && employeeForm.get('country')?.hasError('required')" class="fv-plugins-message-container">
            <div class="fv-help-block">{{ 'MY_COMPANY.COUNTRY_REQUIRED' | translate }}</div>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Footer buttons -->
  <ng-template pTemplate="footer">
    <button 
      type="button"
      class="btn btn-light-primary mx-3 btn-sm"
      (click)="closeAddEmployeeModal()"
      [disabled]="isInviting"
    >
      <i class="ki-duotone ki-cross fs-2"></i>
      {{ 'MY_COMPANY.CANCEL' | translate }}
    </button>
    
    <button 
      type="button"
      class="btn btn-primary btn-sm"
      [disabled]="
        (accountExists && !accountInfo) || 
        (!accountExists && employeeForm.invalid) || 
        (accountExists && !accountInfo.country_id && employeeForm.get('country')?.invalid) ||
        accountExistError !== null || 
        isCheckingAccount || 
        !emailForm.valid ||
        isInviting"
      (click)="inviteEmployee()"
    >
      <span *ngIf="isInviting" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      <i *ngIf="!isInviting" class="ki-duotone ki-check fs-2"></i>
      {{ isInviting ? 'INVITING' : 'MY_COMPANY.INVITE' | translate }}
    </button>
  </ng-template>
</p-dialog>

<!-- Confirmation Dialog for activate/deactivate actions -->
<p-confirmDialog [style]="{width: '450px'}" 
                 acceptButtonStyleClass="btn btn-primary mx-3" 
                 rejectButtonStyleClass="btn btn-light-danger" 
                 appendTo="body"
                 acceptIcon="ki-duotone ki-check" 
                 rejectIcon="ki-duotone ki-cross"></p-confirmDialog>

</div>
