<div class="card">
<div class="card-body">
  <div class="row">
    <div class="col-12">
      
      <!-- Search Bar -->
      <div class="row mb-6">
        <div class="col-12">
          <div class="d-flex align-items-center">
            <div class="position-relative flex-grow-1 me-3">
              <i class="ki-duotone ki-magnifier fs-3 text-gray-500 position-absolute top-50 translate-middle-y ms-6">
                <span class="path1"></span>
                <span class="path2"></span>
              </i>
              <input 
                type="text" 
                class="form-control form-solid ps-15" 
                [formControl]="searchControl"
                [placeholder]="'MY_DOWNLOADS.SEARCH_PLACEHOLDER' | translate"
                autocomplete="off">
            </div>
            @if (currentSearchTerm()) {
              <button 
                type="button" 
                class="btn btn-sm btn-light-danger" 
                (click)="clearSearch()"
                [attr.title]="'COMMON.CLEAR_SEARCH' | translate">
                <i class="ki-duotone ki-cross fs-2">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
              </button>
            }
          </div>
        </div>
      </div>
          
          <!-- Loading State -->
          @if (loading()) {
            <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
              </div>
            </div>
          } @else {
            
            <!-- Three Column Layout -->
            <div class="row" style="min-height: 500px;">
              
              <!-- Column 1: Knowledge Items -->
              <div class="col-lg-4 border-end">
                <div class="d-flex align-items-center gap-2  mb-4">
                  <h5 class="mb-0">{{ 'MY_DOWNLOADS.KNOWLEDGE_ITEMS' | translate }}</h5>
                  <span class="badge badge-light-info">{{ totalItems() }}</span>
            
                </div>
                
                <div class="knowledge-list" style="max-height: 400px; overflow-y: auto;">
                  @if (knowledgeItems().length === 0) {
                    <div class="text-center py-5">
                      @if (currentSearchTerm()) {
                        <i class="ki-duotone ki-magnifier fs-3x text-muted mb-3">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        <p class="text-muted">{{ 'COMMON.NO_SEARCH_RESULTS' | translate }}</p>
                        <button class="btn btn-sm btn-light-info" (click)="clearSearch()">
                          {{ 'COMMON.CLEAR' | translate }}
                        </button>
                      } @else {
                        <i class="ki-duotone ki-folder-down fs-3x text-muted mb-3">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        <p class="text-muted">{{ 'MY_DOWNLOADS.NO_DOWNLOADS' | translate }}</p>
                      }
                    </div>
                  } @else {
                    @for (knowledge of knowledgeItems(); track trackByKnowledgeUuid($index, knowledge)) {
                      <div 
                        class="knowledge-item d-flex align-items-center px-4 py-2 mb-2 border rounded cursor-pointer"
                        [class.active]="selectedKnowledge()?.uuid === knowledge.uuid"
                        (click)="selectKnowledge(knowledge)">
                        
                        <!-- Folder Icon -->
                        <div class="me-3">
                          <i class="ki-duotone ki-folder fs-4 text-info">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                        </div>
                        
                        <!-- Knowledge Title -->
                        <div class="flex-grow-1">
                          <div class=" fs-7 fw-bold">{{ knowledge.title | truncateText: 30 }}</div>
                          <small class="text-muted fs-8">{{ knowledge.type | titlecase }}</small>
                        </div>
                        
                        <!-- Download Icon -->
                        <div class="ms-2">
                          <button 
                            class="btn btn-sm"
                            (click)="downloadKnowledge(knowledge); $event.stopPropagation()"
                            [disabled]="isKnowledgeDownloading(knowledge.uuid)"
                            [attr.title]="'MY_DOWNLOADS.DOWNLOAD_KNOWLEDGE' | translate">
                            @if (isKnowledgeDownloading(knowledge.uuid)) {
                              <span class="spinner-border spinner-border-sm" role="status"></span>
                            } @else {
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM8.47 10.98C8.76 10.69 9.24 10.69 9.53 10.98L11.25 12.7V6.51C11.25 6.1 11.59 5.76 12 5.76C12.41 5.76 12.75 6.1 12.75 6.51V12.7L14.47 10.98C14.76 10.69 15.24 10.69 15.53 10.98C15.82 11.27 15.82 11.75 15.53 12.04L12.53 15.04C12.46 15.11 12.38 15.16 12.29 15.2C12.2 15.24 12.1 15.26 12 15.26C11.9 15.26 11.81 15.24 11.71 15.2C11.62 15.16 11.54 15.11 11.47 15.04L8.47 12.04C8.18 11.75 8.18 11.28 8.47 10.98ZM18.24 17.22C16.23 17.89 14.12 18.23 12 18.23C9.88 18.23 7.77 17.89 5.76 17.22C5.37 17.09 5.16 16.66 5.29 16.27C5.42 15.88 5.84 15.66 6.24 15.8C9.96 17.04 14.05 17.04 17.77 15.8C18.16 15.67 18.59 15.88 18.72 16.27C18.84 16.67 18.63 17.09 18.24 17.22Z" fill="#0978B9"/>
                              </svg>
                            }
                          </button>
                        </div>
                      </div>
                    }
                  }
                </div>
                
                <!-- Pagination -->
                @if (totalPages() > 1) {
                  <div class="d-flex justify-content-center mt-4">
                    <ul class="pagination pagination-sm">
                      <li class="page-item" [class.disabled]="!hasPrevPage()">
                        <a class="page-link" (click)="onPageChange(currentPage() - 1)">
                          <i class="previous"></i>
                        </a>
                      </li>
                      
                      @for (page of getPages(); track trackByPageIndex($index, page)) {
                        <li class="page-item" 
                            [class.active]="page === currentPage()" 
                            [class.disabled]="page === '...'">
                          <a class="page-link" (click)="onPageClick(page)">{{ page }}</a>
                        </li>
                      }
                      
                      <li class="page-item" [class.disabled]="!hasNextPage()">
                        <a class="page-link" (click)="onPageChange(currentPage() + 1)">
                          <i class="next"></i>
                        </a>
                      </li>
                    </ul>
                  </div>
                }
              </div>
              
              <!-- Column 2: Documents -->
              <div class="col-lg-4 border-end">
                <div class="d-flex align-items-center mb-4">
                  <h5 class="mb-0">{{ 'MY_DOWNLOADS.DOCUMENTS' | translate }}</h5>
                  @if (selectedKnowledge()) {
                    <span class="badge badge-light-success ms-2">{{ currentKnowledgeDocuments().length }}</span>
                  }
                </div>
                
                <div class="documents-list" style="max-height: 400px; overflow-y: auto;">
                  @if (!selectedKnowledge()) {
                    <div class="text-center py-5">
                      <i class="ki-duotone ki-document fs-3x text-muted mb-3">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                      <p class="text-muted">{{ 'MY_DOWNLOADS.SELECT_KNOWLEDGE' | translate }}</p>
                    </div>
                  } @else if (currentKnowledgeDocuments().length === 0) {
                    <div class="text-center py-5">
                      <i class="ki-duotone ki-document fs-3x text-muted mb-3">
                        <span class="path1"></span>
                        <span class="path2"></span>
                      </i>
                      <p class="text-muted">{{ 'MY_DOWNLOADS.NO_DOCUMENTS' | translate }}</p>
                    </div>
                  } @else {
                    @for (document of currentKnowledgeDocuments(); track trackByDocumentUuid($index, document)) {
                      <div 
                        class="document-item d-flex align-items-center px-4 py-2 mb-2 border rounded cursor-pointer"
                        [class.active]="selectedDocument()?.uuid === document.uuid"
                        (click)="selectDocument(document)">
                        
                        <!-- Document Icon -->
                        <div class="me-3">
                          <img
                            [src]="getFileIconByExtension(document.file_extension)"
                            [alt]="document.file_extension + ' file'"
                            width="32"
                            height="32"
                            class="file-icon"/>
                        </div>
                        
                        <!-- Document Name -->
                        <div class="flex-grow-1">
                          <div class=" fs-7 fw-bold">{{ document.file_name | truncateText: 30 }}</div>
                          @if (document.price > 0) {
                            <small class="text-muted fs-8">${{ document.price }}</small>
                          } @else {
                            <small class="text-success">{{ 'COMMON.FREE' | translate }}</small>
                          }
                        </div>
                        
                        <!-- Download Icon -->
                        <div class="ms-2">
                          <button 
                            class="btn btn-sm"
                            (click)="downloadDocument(document); $event.stopPropagation()"
                            [disabled]="isDocumentDownloading(document.uuid)"
                            [attr.title]="'MY_DOWNLOADS.DOWNLOAD_DOCUMENT' | translate">
                            @if (isDocumentDownloading(document.uuid)) {
                              <span class="spinner-border spinner-border-sm" role="status"></span>
                            } @else {
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM8.47 10.98C8.76 10.69 9.24 10.69 9.53 10.98L11.25 12.7V6.51C11.25 6.1 11.59 5.76 12 5.76C12.41 5.76 12.75 6.1 12.75 6.51V12.7L14.47 10.98C14.76 10.69 15.24 10.69 15.53 10.98C15.82 11.27 15.82 11.75 15.53 12.04L12.53 15.04C12.46 15.11 12.38 15.16 12.29 15.2C12.2 15.24 12.1 15.26 12 15.26C11.9 15.26 11.81 15.24 11.71 15.2C11.62 15.16 11.54 15.11 11.47 15.04L8.47 12.04C8.18 11.75 8.18 11.28 8.47 10.98ZM18.24 17.22C16.23 17.89 14.12 18.23 12 18.23C9.88 18.23 7.77 17.89 5.76 17.22C5.37 17.09 5.16 16.66 5.29 16.27C5.42 15.88 5.84 15.66 6.24 15.8C9.96 17.04 14.05 17.04 17.77 15.8C18.16 15.67 18.59 15.88 18.72 16.27C18.84 16.67 18.63 17.09 18.24 17.22Z" fill="#0978B9"/>
                              </svg>
                            }
                          </button>
                        </div>
                      </div>
                    }
                  }
                </div>
              </div>
              
              <!-- Column 3: Details -->
              <div class="col-lg-4">
                <div class="d-flex align-items-center gap-2  mb-4">
                  <h5 class="mb-0">{{ 'MY_DOWNLOADS.KNOWLEDGE_SOURCE' | translate }}</h5>
                </div>
                <div class="details-panel">
                  @if (!selectedKnowledge()) {
                    <div class="text-center py-5">
                      <i class="ki-duotone ki-information fs-3x text-muted mb-3">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                      </i>
                      <p class="text-muted">{{ 'MY_DOWNLOADS.SELECT_ITEM_DETAILS' | translate }}</p>
                    </div>
                  } @else {
                    <!-- Background section with type and title -->
                    <div class="details-header">
                      @if (currentKnowledgeDetails(); as details) {
                        <div class="type-label">{{ details.type | uppercase }}</div>
                        <a (click)="viewKnowledge(selectedKnowledge()!); $event.stopPropagation()" class="cursor-pointer">
                        <h2 class="knowledge-title">{{ (selectedKnowledge()?.title || '') | truncateText:40 }}</h2>
                      </a>
                      }
                    </div>

                    <!-- White content area -->
                    <div class="details-content">
                      @if (currentKnowledgeDetails(); as details) {
                        <div class="publisher-info">
                          <div class="publisher-content">
                            <!-- Profile/Company Image Container -->
                            <div class="publisher-image-container">
                              @if (selectedKnowledge()?.company) {
                                <!-- Company logo with insighter photo overlay -->
                                <div class="company-logo-container">
                                  <img 
                                    [src]="selectedKnowledge()?.company?.logo" 
                                    [alt]="selectedKnowledge()?.company?.legal_name"
                                    class="company-logo rounded-circle"
                                    style="object-fit: cover; object-position: top;"
                                    onerror="this.src='assets/images/default-company.png'">
                                  @if (selectedKnowledge()?.insighter_photo) {
                                    <img 
                                      [src]="selectedKnowledge()?.insighter_photo" 
                                      [alt]="selectedKnowledge()?.insighter"
                                      class="insighter-overlay"
                                      style="object-fit: cover; object-position: top;"
                                      onerror="this.src='assets/images/default-avatar.png'">
                                  }
                                </div>
                              } @else if (selectedKnowledge()?.insighter_photo) {
                                <!-- Only insighter photo -->
                                <img 
                                  [src]="selectedKnowledge()?.insighter_photo" 
                                  [alt]="selectedKnowledge()?.insighter"
                                  class="insighter-photo"
                                  style="object-fit: cover; object-position: top;"
                                  onerror="this.src='assets/images/default-avatar.png'">
                              }
                            </div>
                            
                            <!-- Publisher Name and Company Info -->
                            <div class="publisher-text">
                              <h4 class="publisher-name">{{ details.publisher }}</h4>
                              @if (selectedKnowledge()?.company) {
                                <div class="company-info">
                                  <span class="company-prefix text-warning">&#64;</span>
                                  <span class="company-name bg-light-warning text-warning">{{ selectedKnowledge()?.company?.legal_name }}</span>
                                </div>
                              }
                            </div>
                          </div>
                        </div>
                        
                        <div class="purchase-info">
                          <div class="purchase-date">
                            <span class="label">{{ 'MY_DOWNLOADS.PURCHASE_DATE' | translate }}</span>
                            <span class="value">{{ details.purchaseDate | date:'yyyy/MM/dd' }}</span>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              </div>
            </div>
          }
    </div>
  </div>
</div>
</div>