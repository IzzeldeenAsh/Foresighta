<div class="container-fluid">
  <div class="row g-4">
    <!-- Loading State -->
    <div *ngIf="isLoading$ | async" class="col-12">
      <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
        <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">{{ lang === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</span>
        </div>
      </div>
    </div>

    <!-- Orders Cards -->
    <div *ngFor="let order of orders$ | async" class="col-12">
      <div class="card card-custom gutter-b">
        <div class="card-body p-6">
          <!-- Order Header -->
          <div class="d-flex justify-content-between align-items-start mb-4">
            <div class="d-flex align-items-center">
              <div class="symbol symbol-40px me-3">
                <div class="symbol-label bg-light-info">
                  <svg width="24" height="32" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1.30664 12.1711H5.04102C5.61598 12.1712 6.08384 12.6392 6.08398 13.2141V28.5237C6.08398 29.0987 5.61607 29.5676 5.04102 29.5676H1.30664C0.731667 29.5675 0.263672 29.0987 0.263672 28.5237V13.2141C0.263816 12.6392 0.731755 12.1713 1.30664 12.1711Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M3.17435 14.4116C3.33775 14.4119 3.47025 14.545 3.47025 14.7085V24.7896C3.47025 24.953 3.33775 25.0862 3.17435 25.0864C3.01074 25.0864 2.87747 24.9532 2.87747 24.7896V14.7085C2.87747 14.5449 3.01074 14.4116 3.17435 14.4116Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M2.61429 26.7341H3.73441C3.89785 26.7343 4.0303 26.8675 4.0303 27.031C4.03006 27.1943 3.8977 27.3267 3.73441 27.3269H2.61429C2.45083 27.3269 2.31765 27.1944 2.31741 27.031C2.31741 26.8674 2.45068 26.7341 2.61429 26.7341Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M7.63251 12.1711H11.3669C11.9418 12.1712 12.4097 12.6392 12.4099 13.2141V28.5237C12.4099 29.0987 11.9419 29.5676 11.3669 29.5676H7.63251C7.05753 29.5675 6.58954 29.0987 6.58954 28.5237V13.2141C6.58968 12.6392 7.05762 12.1713 7.63251 12.1711Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M9.50024 14.4116C9.66365 14.4119 9.79614 14.545 9.79614 14.7085V24.7896C9.79614 24.953 9.66365 25.0862 9.50024 25.0864C9.33664 25.0864 9.20337 24.9532 9.20337 24.7896V14.7085C9.20337 14.5449 9.33664 14.4116 9.50024 14.4116Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M8.94012 26.7341H10.0602C10.2237 26.7343 10.3561 26.8675 10.3561 27.031C10.3559 27.1943 10.2235 27.3267 10.0602 27.3269H8.94012C8.77667 27.3269 8.64349 27.1944 8.64325 27.031C8.64325 26.8674 8.77652 26.7341 8.94012 26.7341Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M13.5933 12.3933L17.2068 11.4508C17.7631 11.3057 18.334 11.6404 18.4792 12.1967L22.3435 27.0106C22.4886 27.567 22.1542 28.1388 21.5978 28.284L17.9843 29.2266C17.4279 29.3715 16.8567 29.0361 16.7116 28.4797L12.8474 13.6658C12.7024 13.1095 13.0371 12.5386 13.5933 12.3933Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M15.9661 14.0897C16.1243 14.0487 16.2861 14.1441 16.3273 14.3023L18.8719 24.0569C18.9131 24.2151 18.8185 24.3774 18.6605 24.4189C18.5022 24.4602 18.3396 24.3649 18.2983 24.2066L15.7538 14.4519C15.7125 14.2936 15.8078 14.131 15.9661 14.0897Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <path d="M18.5343 26.1542L19.6182 25.8715C19.7764 25.8304 19.9381 25.9258 19.9794 26.084C20.0204 26.2421 19.9257 26.4036 19.7678 26.445L18.6839 26.7278C18.5258 26.769 18.3635 26.6744 18.322 26.5164C18.2807 26.3581 18.376 26.1955 18.5343 26.1542Z" fill="white" stroke="#499AFE" stroke-width="0.527156"/>
                    <g clip-path="url(#clip0_545_160)">
                    <path d="M18.3504 10.4139C15.8686 8.23941 12.3585 7.46563 8.96075 8.34402C8.10046 8.56587 7.26557 8.89254 6.47086 9.31451L8.87457 9.6624C8.98278 9.67807 9.06945 9.73884 9.11885 9.82225C9.15998 9.89169 9.17535 9.97678 9.15584 10.0646C9.11296 10.2582 8.91758 10.3918 8.71939 10.3631L4.93795 9.81571L6.24504 6.3417C6.31554 6.15429 6.52687 6.04759 6.71703 6.10344C6.90712 6.15933 7.00409 6.35651 6.93349 6.54406L6.11594 8.71702C6.9765 8.25668 7.88182 7.90113 8.81502 7.66045C12.4511 6.7205 16.2074 7.54857 18.8633 9.87559C18.8899 9.89888 18.9117 9.92553 18.9288 9.95425C19.0046 10.0823 18.9852 10.2536 18.8696 10.375C18.728 10.5236 18.4956 10.541 18.3504 10.4139Z" fill="#499AFE"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_545_160">
                    <rect width="11.1027" height="11.9671" fill="white" transform="translate(13.7276 1.1731) rotate(59.3625)"/>
                    </clipPath>
                    </defs>
                    </svg>
                    
                      

                </div>
              </div>
              <div>
                <div class="d-flex align-items-center mb-1">
                  <h6 class="mb-0 fw-bold me-2">
                    {{ lang === 'ar' ? 'طلب رقم' : 'Order' }} {{ order.order_no }}
                  </h6>
                  <button 
                    type="button" 
                    class="btn btn-sm btn-light-info p-1"
                    (click)="copyOrderNo(order.order_no)"
                    [title]="lang === 'ar' ? 'نسخ رقم الطلب' : 'Copy Order Number'">
                    <i class="ki-outline ki-copy fs-6"></i>
                  </button>
                </div>
                <div class="text-muted fs-7">{{ order.amount === 0 ? (lang === 'ar' ? 'مجاني' : 'Free') : '$' + order.amount }}</div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button 
                type="button" 
                class="btn btn-info btn-sm"
                (click)="openOrderDetails(order)">
                {{ lang === 'ar' ? 'تفاصيل الطلب' : 'Order Details' }}
              </button>
              <button 
                type="button" 
                class="btn btn-light-info btn-sm"
                (click)="downloadInvoice(order)">
                <i class="ki-outline ki-file-down fs-6 me-1"></i>
                {{ lang === 'ar' ? 'تحميل الفاتورة' : 'Download Invoice' }}
              </button>
            </div>
          </div>

          <!-- Order Info Row -->
          <div class="mb-3 d-flex flex-wrap gap-3">
            <div>
              <span class="text-muted fs-7">{{ lang === 'ar' ? 'النوع:' : 'Type:' }}</span>
              <span class="ms-2 fw-semibold">{{ getServiceTypeDisplay(order.service) }}</span>
            </div>
            <div>
              <span class="text-muted fs-7">{{ lang === 'ar' ? 'طريقة الدفع:' : 'Payment Method:' }}</span>
              <span class="ms-2 fw-semibold">{{ getPaymentMethodDisplay(order.payment) }}</span>
            </div>
            <div>
              <span class="text-muted fs-7">{{ lang === 'ar' ? 'الحالة:' : 'Status:' }}</span>
              <span [class]="getStatusBadgeClass(order.status)" class="ms-2 text-uppercase">
                {{ order.status }}
              </span>
            </div>
          </div>

          <!-- Knowledge Items -->
          <div *ngFor="let suborder of order.suborders; let suborderIndex = index" class="mb-3">
            <div *ngFor="let knowledge of suborder.knowledge" class="mb-2">
              <div class="d-flex align-items-center ">
                <div >
                  <a 
                  [pTooltip]="lang ==='ar' ? 'عرض في التحميلات' : 'View in downloads'"
                  (click)="navigateToDownloads(order, suborderIndex)"
                    target="_blank"
                    class="text-info text-decoration-none fw-bold fs-6 cursor-pointer">
                    {{ knowledge.title }}
                  </a>
                </div>
                <!-- <button 
                  type="button" 
                  class="btn btn-xs btn-light-info ms-2"
                  (click)="navigateToDownloads(knowledge.title)"
                  [title]="lang === 'ar' ? 'عرض في المعرفة' : 'View in Knowledge'">
                  <i class="ki-outline ki-eye fs-6"></i>
                  {{ lang === 'ar' ? 'عرض في المعرفة' : 'View in Knowledge' }}
                </button> -->
              </div>
              
              <!-- Documents Preview -->
              <div *ngIf="suborder.knowledge_documents && suborder.knowledge_documents.length > 0" class="mt-2">
                <div class="d-flex flex-wrap gap-2">
                  <div *ngFor="let extension of getUniqueExtensions(suborder)" class="position-relative d-inline-block">
                    <img 
                      [src]="getFileIconByExtension(extension)" 
                      [alt]="extension"
                      class="file-icon"
                      style="width: 40px; height: 40px;"
                      onerror="this.style.display='none'">
                    <span 
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill text-white"
                      [style.background-color]="getBadgeColorByExtension(extension)">
                      {{ getDocumentCountByExtension(suborder, extension) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Info -->
          <div class="border-top pt-3 mt-3">
            <div class="text-muted fs-7">
              {{ lang === 'ar' ? 'تاريخ الطلب' : 'Ordered' }} {{ order.date | date:'short' }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="(orders$ | async)?.length === 0 && !(isLoading$ | async)" class="col-12">
      <div class="text-center py-10">
        <div class="symbol symbol-100px mx-auto mb-4">
          <div class="symbol-label bg-light-info">
            <i class="pi pi-shopping-bag text-info fs-1"></i>
          </div>
        </div>
        <h5 class="mb-3">{{ lang === 'ar' ? 'لا توجد طلبات' : 'No Orders Found' }}</h5>
        <p class="text-muted">
          {{ lang === 'ar' ? 'لم تقم بأي طلبات بعد' : 'You haven\'t placed any orders yet.' }}
        </p>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="(totalPages$ | async)! > 1" class="d-flex justify-content-center mt-6">
    <p-paginator 
      [rows]="10" 
      [totalRecords]="(totalPages$ | async)! * 10"
      [first]="(currentPage - 1) * 10"
      (onPageChange)="onPageChange(($event.page || 0) + 1)"
      [showCurrentPageReport]="true"
      [currentPageReportTemplate]="lang === 'ar' ? 'عرض {first} إلى {last} من {totalRecords} طلب' : 'Showing {first} to {last} of {totalRecords} orders'">
    </p-paginator>
  </div>
</div>

<!-- Order Details Dialog -->
<p-dialog 
  [(visible)]="showOrderDetails" 
  [header]="lang === 'ar' ? 'تفاصيل الطلب' : 'Order Details'"
  [modal]="true" 
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '50vw', minWidth: '300px' }"
  [contentStyle]="{ 'max-height': '70vh', 'overflow-y': 'auto' }"
  appendTo="body">
  
  <div *ngIf="selectedOrder" class="order-details">
    <!-- Order Header -->
    <div class="mb-4">
      <h6 class="fw-bold mb-2">
        {{ lang === 'ar' ? 'طلب رقم' : 'Order' }} {{ selectedOrder.order_no }}
      </h6>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted">{{ lang === 'ar' ? 'المبلغ:' : 'Amount:' }}</span>
        <span class="fw-bold">{{ selectedOrder.amount === 0 ? (lang === 'ar' ? 'مجاني' : 'Free') : '$'+ selectedOrder.amount }}</span>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted">{{ lang === 'ar' ? 'الحالة:' : 'Status:' }}</span>
        <span [class]="getStatusBadgeClass(selectedOrder.status)" class="text-uppercase">{{ selectedOrder.status }}</span>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted">{{ lang === 'ar' ? 'التاريخ:' : 'Date:' }}</span>
        <span>{{ selectedOrder.date | date:'medium' }}</span>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted">{{ lang === 'ar' ? 'النوع:' : 'Type:' }}</span>
        <span class="fw-bold">{{ getServiceTypeDisplay(selectedOrder.service) }}</span>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <span class="text-muted">{{ lang === 'ar' ? 'طريقة الدفع:' : 'Payment:' }}</span>
        <span class="fw-bold">{{ getPaymentMethodDisplay(selectedOrder.payment) }}</span>
      </div>
    </div>

    <!-- Knowledge Items -->
    <div *ngFor="let suborder of selectedOrder.suborders" class="mb-4">
      <div *ngFor="let knowledge of suborder.knowledge" class="border rounded p-3 mb-3">
        <h6 class="mb-3 text-info">
          <a 
            [href]="getKnowledgeUrl(knowledge)" 
            target="_blank"
            class="text-info text-decoration-none">
            {{ knowledge.title }}
          </a>
        </h6>
        
        <!-- Documents -->
        <div *ngIf="suborder.knowledge_documents && suborder.knowledge_documents.length > 0">
          <h6 class="fs-7 text-muted mb-2">{{ lang === 'ar' ? 'المستندات:' : 'Documents:' }}</h6>
          <div class="row g-2">
            <ng-container *ngFor="let docGroup of suborder.knowledge_documents">
              <div *ngFor="let doc of docGroup" class="col-md-12">
                <div class="card card-flush border border-gray-300">
                  <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                      <img 
                        [src]="getFileIconByExtension(doc.file_extension)" 
                        [alt]="doc.file_extension"
                        class="me-3"
                        style="width: 40px; height: 40px;"
                        onerror="this.style.display='none'">
                      <div class="flex-grow-1">
                        <div class="fw-bold fs-6">{{ doc.file_name }}</div>
                        <div class="text-muted fs-7">{{ doc.file_extension.toUpperCase() }}</div>
                      </div>
                      <div class="text-end">
                        <div class="fw-bold text-info">{{ doc.price === 0 ? (lang === 'ar' ? 'مجاني' : 'Free') : '$' + doc.price }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

  </div>
</p-dialog>