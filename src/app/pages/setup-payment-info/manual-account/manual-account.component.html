<p-toast></p-toast>
<app-payment-header 
  [title]="lang === 'ar' ? 'إعداد حسابك البنكي' : 'Bank Account Setup'"
  [subtitle]="lang === 'ar' ? 'أدخل معلومات حسابك البنكي لاستقبال المدفوعات' : 'Enter your bank account details to receive payments'">
</app-payment-header>

<div style="padding-top:50px" class="container-fluid  gradient-background">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-xl-5">

        
        <form [formGroup]="manualAccountForm" (ngSubmit)="onSubmit()">
            <!-- Country Selection Field -->
            <div class="mb-6">
              <label class="form-label required">
                {{ lang === 'ar' ? 'البلد' : 'Country' }}
              </label>
              <p-dropdown 
                [options]="countries"
                formControlName="countryId"
                optionLabel="name"
                optionValue="id"
                [filter]="true"
                [filterBy]="'name'"
                [showClear]="true"
                [placeholder]="lang === 'ar' ? 'اختر البلد' : 'Select Country'"
                [filterPlaceholder]="lang === 'ar' ? 'ابحث عن بلد...' : 'Search for a country...'"
                [class.p-invalid]="getFieldError('countryId')"
                styleClass="w-100"
                (onChange)="onCountryChange($event)"
              >
                <ng-template pTemplate="item" let-country>
                  <div class="d-flex align-items-center">
                    <img 
                      *ngIf="country.showFlag"
                      [src]="getFlagUrl(country.flag)" 
                      [alt]="country.name"
                      class="me-3"
                      style="width: 24px; height: 16px; object-fit: cover;"
                      (error)="onFlagError(country)"
                    />
                    <span>{{ country.name }}</span>
                  </div>
                </ng-template>
                <ng-template pTemplate="selectedItem" let-country>
                  <div class="d-flex align-items-center" *ngIf="country">
                    <img 
                      *ngIf="country.showFlag"
                      [src]="getFlagUrl(country.flag)" 
                      [alt]="country.name"
                      class="me-3"
                      style="width: 24px; height: 16px; object-fit: cover;"
                      (error)="onFlagError(country)"
                    />
                    <span>{{ country.name }}</span>
                  </div>
                </ng-template>
              </p-dropdown>
              <div class="invalid-feedback d-block" *ngIf="getFieldError('countryId')">
                {{ getFieldError('countryId') }}
              </div>
            </div>

            <!-- Account Name Field -->
            <div class="mb-6">
              <label class="form-label required">
                {{ getAccountNameLabel() }}
              </label>
              <input
                type="text"
                class="form-control"
                [class.is-invalid]="getFieldError('accountName')"
                formControlName="accountName"
                [placeholder]="isCompanyAccount 
                  ? (lang === 'ar' ? 'أدخل الاسم القانوني للشركة' : 'Enter company legal name')
                  : (lang === 'ar' ? 'أدخل الاسم الكامل' : 'Enter full name')"
              />
              <div class="invalid-feedback" *ngIf="getFieldError('accountName')">
                {{ getFieldError('accountName') }}
              </div>
              <div class="form-text text-muted">
                <i class="fas fa-info-circle me-1"></i>
                {{ lang === 'ar' 
                  ? 'يجب أن يكون الاسم مطابقاً تماماً لاسم الحساب البنكي' 
                  : 'Should be exactly as the name of the bank account' 
                }}
              </div>
            </div>

            <!-- IBAN Field -->
            <div class="mb-6">
              <label class="form-label required">
                {{ lang === 'ar' ? 'رقم الآيبان (IBAN)' : 'IBAN Number' }}
              </label>
              <input
                type="text"
                class="form-control"
                [class.is-invalid]="getFieldError('iban')"
                formControlName="iban"
                [placeholder]="lang === 'ar' ? 'أدخل رقم الآيبان' : 'Enter IBAN number'"
              />
              <div class="invalid-feedback" *ngIf="getFieldError('iban')">
                {{ getFieldError('iban') }}
              </div>
              <div class="form-text text-muted">
                {{ lang === 'ar' ? 'مثال: SA03 8000 0000 6080 1016 7519' : 'Example: SA03 8000 0000 6080 1016 7519' }}
              </div>
            </div>

            <!-- Address Field -->
            <div class="mb-6">
              <label class="form-label required">
                {{ lang === 'ar' ? 'العنوان' : 'Address' }}
              </label>
              <input
                type="text"
                class="form-control"
                [class.is-invalid]="getFieldError('address')"
                formControlName="address"
                [placeholder]="lang === 'ar' ? 'أدخل العنوان' : 'Enter address'"
              />
              <div class="invalid-feedback" *ngIf="getFieldError('address')">
                {{ getFieldError('address') }}
              </div>
              <div class="form-text text-muted">
                <i class="fas fa-info-circle me-1"></i>
                {{ lang === 'ar' 
                  ? 'يجب أن يكون العنوان مطابقاً تماماً للعنوان المذكور في الحساب البنكي' 
                  : 'Should be exactly as the address of the bank account' 
                }}
              </div>
            </div>

            <!-- SWIFT Code Field -->
            <div class="mb-6">
              <label class="form-label">
                {{ lang === 'ar' ? 'رمز السويفت (SWIFT)' : 'SWIFT Code' }}
                <span class="text-gray-500">{{ lang === 'ar' ? '(اختياري)' : '(Optional)' }}</span>
              </label>
              <input
                type="text"
                class="form-control"
                formControlName="swift_code"
                [placeholder]="lang === 'ar' ? 'أدخل رمز السويفت' : 'Enter SWIFT code'"
              />
              <div class="invalid-feedback" *ngIf="getFieldError('swift_code')">
                {{ getFieldError('swift_code') }}
              </div>
            </div>

            <!-- Phone Field -->
            <div class="mb-6">
              <label class="form-label required">
                {{ lang === 'ar' ? 'رقم الهاتف' : 'Phone Number' }}
              </label>
              <app-phone-number-input
                #phoneInput
                [countries]="countries"
                [placeholder]="lang === 'ar' ? 'رقم هاتفك' : 'Your phone number'"
                [searchPlaceholder]="'Search countries...'"
                [lang]="lang"
                [isRequired]="true"
                [showValidationErrors]="true"
                [countryCodeError]="getFieldError('phoneCountryCode')"
                [phoneNumberError]="getFieldError('phoneNumber')"
                [initialCountryCode]="manualAccountForm.get('phoneCountryCode')?.value"
                [initialPhoneNumber]="manualAccountForm.get('phoneNumber')?.value"
                (countryCodeChange)="onCountryCodeChange($event)"
                (phoneNumberChange)="onPhoneNumberChange($event)"
                (formattedPhoneNumberChange)="onFormattedPhoneNumberChange($event)"
                (flagError)="onFlagError($event)"
              ></app-phone-number-input>
            </div>

            <!-- OTP Code Field -->
            <div class="mb-6">
              <label class="form-label required">
                {{ lang === 'ar' ? 'رمز التحقق' : 'Verification Code' }}
              </label>
              <div class="input-group" [class.is-invalid]="getFieldError('code')">
                <!-- For Arabic: Button first, then Input -->
                <ng-container *ngIf="lang === 'ar'">
                  <input
                  type="text"
                  class="form-control text-end"
                  [class.is-invalid]="getFieldError('code')"
                  style="border-radius: 0 0.375rem 0.375rem 0;"
                  formControlName="code"
                  placeholder="أدخل رمز التحقق"
                  dir="rtl"
                />
                  <button
                    type="button"
                    class="btn btn-outline-info"
                    [class.border-danger]="getFieldError('code')"
                    style="border-radius: 0.375rem 0 0 0.375rem;"
                    (click)="resendOtp()"
                    [disabled]="!canResendOtp">
                    <span *ngIf="canResendOtp">
                      {{ 'الحصول على الرمز' }}
                    </span>
                    <span *ngIf="!canResendOtp">
                      {{ resendCooldown }}{{ 'ث' }}
                    </span>
                  </button>

                </ng-container>

                <!-- For English: Input first, then Button -->
                <ng-container *ngIf="lang === 'en'">
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="getFieldError('code')"
                    style="border-radius: 0.375rem 0 0 0.375rem;"
                    formControlName="code"
                    placeholder="Enter verification code"
                    dir="ltr"
                  />
                  <button
                    type="button"
                    class="btn btn-info"
                    [class.border-danger]="getFieldError('code')"
                    style="border-radius: 0 0.375rem 0.375rem 0;"
                    (click)="resendOtp()"
                    [disabled]="!canResendOtp">
                    <span *ngIf="canResendOtp">
                      {{ 'Get Code' }}
                    </span>
                    <span *ngIf="!canResendOtp">
                      {{ resendCooldown }}{{ 's' }}
                    </span>
                  </button>
                </ng-container>
              </div>
              <div class="invalid-feedback d-block" *ngIf="getFieldError('code')">
                {{ getFieldError('code') }}
              </div>
              <div class="form-text text-muted">
                <i class="fas fa-envelope me-1"></i>
                {{ lang === 'ar'
                  ? 'سيتم إرسال رمز التحقق إلى عنوان بريدك الإلكتروني'
                  : 'Verification code will be sent to your email address'
                }}
              </div>
            </div>

            <!-- Terms and Conditions Checkbox (only for new accounts) -->
            <div *ngIf="!isEditing" class="mb-6">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="termsAccepted"
                  formControlName="termsAccepted"
                  [class.is-invalid]="getFieldError('termsAccepted')"
                  [disabled]="termsAccepted"
                />
                <label class="form-check-label required" for="termsAccepted">
                  {{ lang === 'ar' ? 'أوافق على' : 'I agree to the' }}
                  <a 
                    href="javascript:void(0)" 
                    class="text-info text-decoration-underline"
                    (click)="openTermsDialog()"
                  >
                    {{ lang === 'ar' ? 'الشروط والأحكام' : 'Terms & Conditions' }}
                  </a>
                </label>
                <div class="invalid-feedback" *ngIf="getFieldError('termsAccepted')">
                  {{ getFieldError('termsAccepted') }}
                </div>
                <div *ngIf="termsAccepted" class="form-text text-success mt-1">
                  <i class="fas fa-check-circle me-1"></i>
                  {{ lang === 'ar' ? 'تم قبول الشروط والأحكام' : 'Terms & Conditions accepted' }}
                </div>
              </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-light-info mb-0">
              <div class="d-flex align-items-center">
                <i class="fas fa-info-circle text-info fs-2 me-3"></i>
                <div>
                  <p class="mb-1 fw-bold">
                    {{ lang === 'ar' ? 'معلومات هامة' : 'Important Information' }}
                  </p>
                  <p class="mb-0 text-muted">
                    {{ lang === 'ar' 
                      ? 'تأكد من صحة المعلومات المدخلة. سيتم استخدام هذه المعلومات لتحويل المدفوعات إليك.' 
                      : 'Please ensure the information is correct. These details will be used to transfer payments to you.' 
                    }}
                  </p>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between pt-5">
              <button 
                type="button" 
                class="btn btn-light"
                (click)="goBack()">
                {{ lang === 'ar' ? 'السابق' : 'Back' }}
              </button>
              
              <button 
                type="submit"
                class="btn btn-info"
                [disabled]="paymentService.isLoading$ | async">
                
                <span 
                  *ngIf="paymentService.isLoading$ | async"
                  class="spinner-border spinner-border-sm me-2" 
                  role="status" 
                  aria-hidden="true">
                </span>
                
                {{ lang === 'ar' ? 'تعديل الإعدادات' : 'Update Settings' }}
              </button>
            </div>
        </form>
    </div>
  </div>
</div>

<!-- Terms & Conditions Dialog -->
<p-dialog 
  [(visible)]="showTermsDialog" 
  [modal]="true" 
  [closable]="true" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '800px'}"
>
  <ng-template pTemplate="header">
    <div class="d-flex justify-content-between align-items-center w-100">
      <h5 class="m-0">{{ lang === 'ar' ? 'شروط وأحكام محفظة الدفع' : 'Wallet Payment Terms & Conditions' }}</h5>
      <div class="d-flex">
        <button 
          class="btn btn-sm btn-icon me-2" 
          (click)="printTerms()"
          [disabled]="isLoadingTerms"
        >
          <i class="ki-outline ki-printer fs-3"></i>
        </button>
        <button 
          class="btn btn-sm btn-icon" 
          (click)="saveTerms()"
          [disabled]="isLoadingTerms"
        >
          <i class="ki-outline ki-save-2 fs-3"></i>
        </button>
      </div>
    </div>
  </ng-template>

  <div class="terms-content" style="max-height: 60vh; overflow-y: auto;">
    <div *ngIf="isLoadingTerms" class="text-center py-4">
      <div class="spinner-border text-info" role="status">
        <span class="visually-hidden">{{ lang === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</span>
      </div>
    </div>
    
    <div *ngIf="!isLoadingTerms && termsContent" [innerHTML]="termsContent"></div>
    
    <div *ngIf="!isLoadingTerms && !termsContent" class="text-center py-4 text-muted">
      <i class="fas fa-exclamation-triangle fs-2x mb-3"></i>
      <p>{{ lang === 'ar' ? 'لا يمكن تحميل الشروط والأحكام' : 'Unable to load Terms & Conditions' }}</p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="d-flex justify-content-end gap-3">
      <button 
        type="button" 
        class="btn btn-outline-secondary"
        (click)="declineTerms()"
      >
        {{ lang === 'ar' ? 'رفض' : 'Decline' }}
      </button>
      <button 
        type="button" 
        class="btn btn-info"
        (click)="acceptTerms()"
        [disabled]="isLoadingTerms"
      >
        {{ lang === 'ar' ? 'أوافق' : 'I Agree' }}
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Unsaved Changes Warning Dialog -->
<p-dialog 
  [(visible)]="showUnsavedChangesDialog" 
  [modal]="true" 
  [closable]="false" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '500px'}"
>
  <ng-template pTemplate="header">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle text-warning fs-2 me-3"></i>
      <h5 class="m-0">{{ lang === 'ar' ? 'تغييرات غير محفوظة' : 'Unsaved Changes' }}</h5>
    </div>
  </ng-template>

  <div class="py-3">
    <p class="mb-0">
      {{ lang === 'ar' 
        ? 'لديك تغييرات غير محفوظة. هل تريد المتابعة وفقدان هذه التغييرات؟' 
        : 'You have unsaved changes. Do you want to continue and lose these changes?' 
      }}
    </p>
  </div>

  <ng-template pTemplate="footer">
    <div class="d-flex justify-content-end gap-3">
      <button 
        type="button" 
        class="btn btn-light"
        (click)="onStayOnPage()"
      >
        {{ lang === 'ar' ? 'البقاء في الصفحة' : 'Stay on Page' }}
      </button>
      <button 
        type="button" 
        class="btn btn-danger"
        (click)="onDiscardChanges()"
      >
        {{ lang === 'ar' ? 'تجاهل التغييرات' : 'Discard Changes' }}
      </button>
    </div>
  </ng-template>
</p-dialog>