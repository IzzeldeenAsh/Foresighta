<p-toast></p-toast>
<app-payment-header 
  [title]="lang === 'ar' ? 'إعداد حساب الدفع' : 'Setup Payment Account'"
  [subtitle]="lang === 'ar' ? 'اختر طريقة الدفع المناسبة لك وقم بإعداد حسابك البنكي بسهولة وأمان' : 'Choose your preferred payment method and setup your digital wallet easily and securely'">
</app-payment-header>

<div style="padding-top:50px" class="gradient-background ">

  <div class="container-fluid">
    <div class="row">
      <div class="col-12 mx-auto col-md-6">
        
        <!-- Loading Spinner -->
        <div *ngIf="isLoadingPaymentInfo" class="text-center py-5">
          <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="mt-3">
            <h5 class="text-gray-700">
              {{ lang === 'ar' ? 'جاري تحميل معلومات الدفع...' : 'Loading payment information...' }}
            </h5>
            <p class="text-muted">
              {{ lang === 'ar' ? 'يرجى الانتظار' : 'Please wait' }}
            </p>
          </div>
        </div>

        <!-- Main Content -->
        <div *ngIf="!isLoadingPaymentInfo">
 
            <!-- Existing Payment Warning -->
            <div *ngIf="hasExistingPayment && paymentInfo && !isEditing" class="mb-8">
              <div class="payment-warning-card">
                <div class="text-center mb-4">
                  <i class="fas fa-info-circle text-primary fs-1 mb-3"></i>
                  
                  <!-- Active account message -->
                  <div *ngIf="paymentInfo.status === 'active'">
                    <h4 class="mb-2">
                      {{ lang === 'ar' ? 'لديك حساب دفع نشط بالفعل' : 'You have an active payment account' }}
                    </h4>
                    <p class="text-muted mb-3">
                      {{ lang === 'ar' ? 'أي تغيير سيؤثر على الإعدادات الحالية' : 'Any changes will override your current settings' }}
                    </p>
                  </div>
                  
                  <!-- Inactive Stripe account message -->
                  <div *ngIf="paymentInfo.type === 'provider' && paymentInfo.status === 'inactive'">
                    <h4 class="mb-2">
                      {{ lang === 'ar' ? 'لديك حساب Stripe غير مكتمل' : 'You have an incomplete Stripe account' }}
                    </h4>
                    <p class="text-muted mb-3" *ngIf="paymentInfo.details_submitted_at === null">
                      {{ lang === 'ar' ? 'يجب إكمال إعداد حساب Stripe الخاص بك' : 'You need to complete your Stripe account setup' }}
                    </p>
                    <p class="text-muted mb-3" *ngIf="paymentInfo.details_submitted_at !== null">
                      {{ lang === 'ar' ? 'حسابك قيد المراجعة من قبل Stripe' : 'Your account is under review by Stripe' }}
                    </p>
                  </div>
                  <div class="payment-type-info">
                    <span class="badge bg-light text-dark">
                      {{ paymentInfo.type === 'manual' ? (lang === 'ar' ? 'حساب يدوي' : 'Manual Account') : 'Stripe Account' }}
                      <span class="status-dot ms-2" [class]="paymentInfo.status === 'active' ? 'active' : 'inactive'"></span>
                    </span>
                  </div>
                </div>
                
                <div class="text-center">
                  <!-- Manual Account Actions -->
                  <div *ngIf="paymentInfo.type === 'manual'" class="d-flex justify-content-center gap-3 flex-wrap">
                    <button class="btn btn-primary" (click)="onEditManual()">
                      <i class="fas fa-edit me-2"></i>
                      {{ lang === 'ar' ? 'تعديل الحساب' : 'Edit Account' }}
                    </button>
                    <button class="btn btn-outline-info" (click)="onChangeToStripe()">
                      <i class="fas fa-exchange-alt me-2"></i>
                      {{ lang === 'ar' ? 'تغيير إلى Stripe' : 'Switch to Stripe' }}
                    </button>
                  </div>
                  
                  <!-- Stripe Account Actions -->
                  <div *ngIf="paymentInfo.type === 'provider'">
                    <div *ngIf="paymentInfo.status === 'active'" class="d-flex justify-content-center gap-3 flex-wrap">
                      <button class="btn btn-primary" (click)="onCompleteStripe()">
                        <i class="fas fa-edit me-2"></i>
                        {{ lang === 'ar' ? 'تعديل Stripe' : 'Edit Stripe' }}
                      </button>
                      <button class="btn btn-outline-info" (click)="onChangeToManual()">
                        <i class="fas fa-exchange-alt me-2"></i>
                        {{ lang === 'ar' ? 'تغيير إلى يدوي' : 'Switch to Manual' }}
                      </button>
                    </div>
                    
                    <!-- Show Complete Stripe Setup if details not submitted -->
                    <div *ngIf="paymentInfo.status === 'inactive' && paymentInfo.details_submitted_at === null">
                      <!-- Redirect Spinner -->
                      <div *ngIf="isWaitingForRedirect" class="text-center py-4">
                        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-3">
                          <h5 class="text-gray-700">
                            {{ lang === 'ar' ? 'جاري التوجيه لإكمال Stripe...' : 'Redirecting to complete Stripe...' }}
                          </h5>
                          <p class="text-muted">
                            {{ lang === 'ar' ? 'يرجى الانتظار' : 'Please wait' }}
                          </p>
                        </div>
                      </div>
                      
                      <!-- Action Buttons -->
                      <div *ngIf="!isWaitingForRedirect" class="d-flex justify-content-center gap-3 flex-wrap">
                        <button class="btn btn-success" (click)="onCompleteStripeRedirect()">
                          <i class="fas fa-check me-2"></i>
                          {{ lang === 'ar' ? 'إكمال Stripe' : 'Complete Stripe' }}
                        </button>
                        <button class="btn btn-outline-info" (click)="onChangeToManual()">
                          <i class="fas fa-exchange-alt me-2"></i>
                          {{ lang === 'ar' ? 'تغيير إلى يدوي' : 'Switch to Manual' }}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Show waiting for approval message if details submitted but account inactive -->
                    <div *ngIf="paymentInfo.status === 'inactive' && paymentInfo.details_submitted_at !== null" class="text-center">
                      <button class="btn btn-outline-info" (click)="onChangeToManual()">
                        <i class="fas fa-exchange-alt me-2"></i>
                        {{ lang === 'ar' ? 'تغيير إلى يدوي' : 'Switch to Manual' }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 1: Payment Type Selection -->
            <div class="mb-8" *ngIf="!hasExistingPayment || isEditing">
              <div class="d-flex align-items-center mb-4">
                <span class="badge badge-circle badge-info me-3">1</span>
                <h4 class="mb-0 text-gray-800 fw-bold">
                  {{ lang === 'ar' ? 'اختر نوع الدفع' : 'Select Payment Type' }}
                </h4>
              </div>
              <p class="text-muted mb-4">
                {{ lang === 'ar' ? 'اختر طريقة الدفع المفضلة لديك' : 'Choose your preferred payment method' }}
              </p>
              
              <div class="row">
                <div class="col-lg-6 mb-4" *ngFor="let type of paymentTypes">
                  <input 
                    name="paymentType"
                    type="radio"
                    class="btn-check"
                    [id]="type.id"
                    [value]="type.id"
                    [checked]="selectedPaymentType === type.id"
                    (change)="selectPaymentType(type.id)"
                  />
                  <label
                    class="btn btn-outline btn-outline-dashed btn-outline-default p-7 d-flex align-items-center position-relative hover-elevate-up shadow-sm rounded-3 transition h-100"
                    [for]="type.id"
                    style="cursor: pointer"
                  >
                    <!-- Payment type icon -->
                    <div class="mx-5 my-5">
                      <img [src]="type.imageUrl" alt="Payment method icon" style="width: 38px; height: 38px; object-fit: contain;" />
                    </div>
                    
                    <span class="d-block fw-bold text-inline-start">
                      <div class="d-flex justify-content-between">
                        <span class="text-gray-900 fw-bolder d-block fs-4 mb-2">
                          {{ lang === 'ar' ? type.name.ar : type.name.en }}
                        </span>
                      </div>
                      <span class="text-gray-500 fw-bold fs-6">
                        {{ lang === 'ar' ? type.description.ar : type.description.en }}
                      </span>
                    </span>
                  </label>
                </div>
              </div>
              
              <!-- Validation error for payment type -->
              <div 
                *ngIf="showValidationErrors && !selectedPaymentType" 
                class="text-danger mt-3 fs-7 d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ lang === 'ar' ? 'يرجى اختيار نوع الدفع' : 'Please select a payment type' }}
              </div>
            </div>
    
            <!-- Step 2: Country Selection -->
            <div *ngIf="selectedPaymentType && (!hasExistingPayment || isEditing)" class="mb-8">
              <div class="d-flex align-items-center mb-4">
                <span class="badge badge-circle badge-info me-3">2</span>
                <h4 class="mb-0 text-gray-800 fw-bold">
                  {{ lang === 'ar' ? 'اختر الدولة' : 'Select Country' }}
                </h4>
              </div>
              <p class="text-muted mb-4">
                {{ lang === 'ar' ? 'اختر الدولة التي تريد إجراء المعاملات منها' : 'Select the country you want to transact from' }}
              </p>

              <!-- Selected Country Display -->
              <div *ngIf="selectedCountry" class="mb-4">
                <div class="selected-country-display">
                  <div class="country-card selected" (click)="unselectCountry()" style="cursor: pointer;">
                    <div class="country-card-content">
                      <div class="country-flag-option">
                        <img 
                          [src]="getFlagUrl(selectedCountry.flag)" 
                          [alt]="getCountryName(selectedCountry)"
                          class="flag-image"
                          onerror="this.src='assets/media/flags/default.svg'">
                      </div>
                      <div class="country-name">
                        {{ getCountryName(selectedCountry) }}
                      </div>
                    </div>
                    <div class="country-check">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <button class="btn btn-sm btn-light-info mt-2" (click)="unselectCountry()">
                    <i class="fas fa-edit me-1"></i>
                    {{ lang === 'ar' ? 'تغيير الدولة' : 'Change Country' }}
                  </button>
                </div>
              </div>

              <!-- Country Selection Interface (shown when no country is selected) -->
              <div *ngIf="!selectedCountry">
                <!-- Search Bar -->
                <div class="search-container position-relative mb-4">
                  <i class="fas fa-search position-absolute" 
                     style="left: 16px; top: 50%; transform: translateY(-50%); color: #a1a5b7; z-index: 2;"></i>
                  <input 
                    type="text" 
                    class="form-control ps-10"
                    [(ngModel)]="searchTerm"
                    (input)="filterCountries()"
                    [placeholder]="lang === 'ar' ? 'البحث عن دولة...' : 'Search for a country...'"
                    style="padding-left: 45px;">
                  <span class="position-absolute" style="right: 16px; top: 50%; transform: translateY(-50%); color: #a1a5b7;">
                    <small class="text-muted">{{ filteredCountries.length }} {{ lang === 'ar' ? 'دولة' : 'countries' }}</small>
                  </span>
                </div>
      
                <!-- Countries Grid -->
                <div class="countries-grid">
                  <div 
                    *ngFor="let country of filteredCountries" 
                    class="country-card"
                    (click)="selectCountry(country)">
                    
                    <div class="country-card-content">
                      <div class="country-flag-option">
                        <img 
                          [src]="getFlagUrl(country.flag)" 
                          [alt]="getCountryName(country)"
                          class="flag-image"
                          onerror="this.src='assets/media/flags/default.svg'">
                      </div>
                      <div class="country-name">
                        {{ getCountryName(country) }}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- No results message -->
                <div 
                  *ngIf="filteredCountries.length === 0 && searchTerm" 
                  class="text-center py-5 text-muted">
                  <i class="fas fa-search fs-2x mb-3 text-gray-400"></i>
                  <p>{{ lang === 'ar' ? 'لم يتم العثور على نتائج' : 'No countries found' }}</p>
                  <button class="btn btn-sm btn-light-info mt-2" (click)="searchTerm = ''; filterCountries()">
                    <i class="fas fa-times me-1"></i>
                    {{ lang === 'ar' ? 'مسح البحث' : 'Clear search' }}
                  </button>
                </div>
              </div>
              
              <!-- Validation error for country -->
              <div 
                *ngIf="showValidationErrors && !selectedCountry" 
                class="text-danger mt-3 fs-7 d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ lang === 'ar' ? 'يرجى اختيار الدولة' : 'Please select a country' }}
              </div>
            </div>
          </div>
    
          <!-- Terms & Conditions Agreement -->
          <div class="mb-4" *ngIf="selectedCountry && (!hasExistingPayment || isEditing)">
            <div class="form-check d-flex align-items-start">
              <input 
                class="form-check-input me-3 mt-1" 
                type="checkbox" 
                id="termsAgreement"
                [(ngModel)]="termsAgreed">
              <label class="form-check-label" for="termsAgreement">
                <span *ngIf="lang === 'ar'">
                  أوافق على إنشاء حساب دفع وأقرّ أني قرأت وفهمت 
                  <a href="javascript:void(0)" 
                     class="text-decoration-underline fw-bold text-info" 
                     (click)="openTermsDialog()">شروط وأحكام الاتفاقية</a>.
                </span>
                <span *ngIf="lang !== 'ar'">
                  I agree to create a Payment Account and acknowledge that I have read and understood the 
                  <a href="javascript:void(0)" 
                     class="text-decoration-underline fw-bold text-info" 
                     (click)="openTermsDialog()">Terms & Conditions</a>.
                </span>
              </label>
            </div>
            
            <!-- Validation error for terms agreement -->
            <div 
              *ngIf="showValidationErrors && !termsAgreed" 
              class="text-danger mt-2 fs-7 d-flex align-items-center">
              <i class="fas fa-exclamation-circle me-2"></i>
              {{ lang === 'ar' ? 'يجب الموافقة على شروط وأحكام الاتفاقية' : 'You must agree to the Terms & Conditions' }}
            </div>
          </div>

          <!-- Footer with Next Button -->
          <div class="card-footer" *ngIf="!hasExistingPayment || isEditing">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">
                <i class="fas fa-shield-alt text-info me-1"></i>
                {{ lang === 'ar' ? 'معلوماتك آمنة ومشفرة' : 'Your information is secure and encrypted' }}
              </div>
              <button 
                type="button"
                class="btn btn-info"
                [disabled]="(paymentService.isLoading$ | async) || isCreatingStripeAccount"
                (click)="onNext()">
                
                <span 
                  *ngIf="(paymentService.isLoading$ | async) || isCreatingStripeAccount"
                  class="spinner-border spinner-border-sm text-white me-2" 
                  role="status" 
                  aria-hidden="true"
                  style="width: 1rem; height: 1rem;">
                </span>
                
                <span *ngIf="!isCreatingStripeAccount">
                  {{ lang === 'ar' ? 'التالي' : 'Next' }}
                  <i class="fas fa-arrow-right ms-2"></i>
                </span>
                
                <span *ngIf="isCreatingStripeAccount">
                  {{ lang === 'ar' ? 'جاري إنشاء حساب Stripe...' : 'Creating Stripe account...' }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Terms & Conditions Dialog -->
  <p-dialog 
    [(visible)]="showTermsDialog" 
    [modal]="true" 
    [closable]="true" 
    [draggable]="false" 
    [resizable]="false"
    [style]="{width: '90vw', maxWidth: '800px'}">
    
    <ng-template pTemplate="header">
      <div class="d-flex justify-content-between align-items-center w-100">
        <h5 class="m-0">{{ lang === 'ar' ? 'شروط وأحكام الاتفاقية' : 'Terms & Conditions' }}</h5>
        <div class="d-flex">
          <button class="btn btn-sm btn-icon me-2" (click)="printTerms()">
            <i class="ki-outline ki-printer fs-3"></i>
          </button>
          <button class="btn btn-sm btn-icon" (click)="saveTerms()">
            <i class="ki-outline ki-save-2 fs-3"></i>
          </button>
        </div>
      </div>
    </ng-template>

    <div class="terms-content" style="max-height: 60vh; overflow-y: auto;">
      <div *ngIf="isLoadingTerms" class="text-center py-4">
        <div class="spinner-border text-info" role="status">
          <span class="visually-hidden">{{ lang === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</span>
        </div>
      </div>
      
      <div *ngIf="!isLoadingTerms && termsContent" [innerHTML]="termsContent"></div>
      
      <div *ngIf="!isLoadingTerms && !termsContent" class="text-center py-4 text-muted">
        <i class="fas fa-exclamation-triangle fs-2x mb-3"></i>
        <p>{{ lang === 'ar' ? 'لا يمكن تحميل الشروط والأحكام' : 'Unable to load Terms & Conditions' }}</p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="d-flex justify-content-end gap-3">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="declineTerms()">
          {{ lang === 'ar' ? 'رفض' : 'Decline' }}
        </button>
        <button 
          type="button" 
          class="btn btn-info"
          (click)="acceptTerms()">
          {{ lang === 'ar' ? 'قبول' : 'Accept' }}
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- OTP Verification Dialog -->
  <p-dialog 
    [(visible)]="showOtpDialog" 
    [modal]="true" 
    [closable]="true" 
    [draggable]="false" 
    [resizable]="false"
    [style]="{width: '90vw', maxWidth: '500px'}"
    header="{{ lang === 'ar' ? 'تحقق من هويتك' : 'Verify Your Identity' }}">

    <div class="otp-content">
      <!-- Redirect Loader -->
      <div *ngIf="isWaitingForRedirect" class="text-center py-5">
        <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3">
          <h5 class="text-gray-700">
            {{ lang === 'ar' ? 'جاري التوجيه إلى Stripe...' : 'Redirecting to Stripe...' }}
          </h5>
          <p class="text-muted">
            {{ lang === 'ar' ? 'يرجى الانتظار' : 'Please wait' }}
          </p>
        </div>
      </div>

      <!-- OTP Form (hidden when redirecting) -->
      <div *ngIf="!isWaitingForRedirect">
        <div class="text-center mb-4">
          <i class="fas fa-shield-check text-info fs-2 mb-3"></i>
          <h5 class="mb-2">
            {{ lang === 'ar' ? 'أدخل رمز التحقق' : 'Enter Verification Code' }}
          </h5>
          <p class="text-muted">
            {{ lang === 'ar' ? 'لقد أرسلنا رمز التحقق إلى بريدك الإلكتروني' : 'We sent a verification code to your email' }}
          </p>
        </div>

        <div class="mb-4">
          <label class="form-label required">
            {{ lang === 'ar' ? 'رمز التحقق' : 'Verification Code' }}
          </label>
          <input
            type="text"
            class="form-control text-center"
            [(ngModel)]="otpCode"
            [placeholder]="lang === 'ar' ? 'أدخل الرمز' : 'Enter code'"
            maxlength="10"
            (keypress)="$event.key === 'Enter' && submitOtp()"
            autocomplete="off"
            [disabled]="isSubmittingOtp"
          />
          <div class="form-text text-muted mt-2">
            <i class="fas fa-envelope me-1"></i>
            {{ lang === 'ar' ? 'تحقق من بريدك الإلكتروني ومجلد الرسائل المزعجة (تنتهي فعالية الكود في 1 ساعة)' : 'Check your email and spam folder (Code expires in 1 hour)' }}
          </div>
        </div>

        <div class="text-center mb-3">
          <span 
            *ngIf="canResendOtp"
            class="text-info text-decoration-underline"
            style="cursor: pointer;"
            (click)="resendOtp()"
          >
            <i class="fas fa-paper-plane me-1"></i>
            {{ lang === 'ar' ? 'إعادة إرسال الرمز' : 'Resend Code' }}
          </span>
          <span 
            *ngIf="!canResendOtp"
            class="text-muted"
          >
            <i class="fas fa-clock me-1"></i>
            {{ lang === 'ar' ? 'إعادة الإرسال متاحة خلال' : 'Resend available in' }} {{ resendCooldown }}{{ lang === 'ar' ? 'ث' : 's' }}
          </span>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="d-flex justify-content-between" *ngIf="!isWaitingForRedirect">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="closeOtpDialog()">
          {{ lang === 'ar' ? 'إلغاء' : 'Cancel' }}
        </button>
        <button 
          type="button" 
          class="btn btn-info"
          [disabled]="isSubmittingOtp || !otpCode.trim()"
          (click)="submitOtp()">
          
          <span 
            *ngIf="isSubmittingOtp"
            class="spinner-border spinner-border-sm me-2" 
            role="status" 
            aria-hidden="true">
          </span>
          
          {{ lang === 'ar' ? 'تأكيد' : 'Verify' }}
        </button>
      </div>
    </ng-template>
  </p-dialog>