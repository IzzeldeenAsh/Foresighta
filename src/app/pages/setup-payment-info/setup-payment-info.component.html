<p-toast></p-toast>
<app-payment-header 
  [title]="lang === 'ar' ? 'إعداد حساب الدفع' : 'Setup Payment Account'"
  [subtitle]="lang === 'ar' ? 'اختر طريقة الدفع المناسبة لك وقم بإعداد حسابك البنكي بسهولة وأمان' : 'Choose your preferred payment method and setup your digital wallet easily and securely'">
</app-payment-header>

<div style="padding-top:50px" class="gradient-background ">

  <div class="container-fluid">
    <div class="row">
      <div class="col-12 mx-auto col-md-6">
        
        <!-- Loading Spinner -->
        <div *ngIf="isLoadingPaymentInfo" class="text-center py-5">
          <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="mt-3">
            <h5 class="text-gray-700">
              {{ lang === 'ar' ? 'جاري تحميل معلومات الدفع...' : 'Loading payment information...' }}
            </h5>
            <p class="text-muted">
              {{ lang === 'ar' ? 'يرجى الانتظار' : 'Please wait' }}
            </p>
          </div>
        </div>

        <!-- Main Content -->
        <div *ngIf="!isLoadingPaymentInfo">
          <form [formGroup]="paymentForm">

            <!-- Step 1: Payment Type Selection -->
            <div class="mb-8">
              <div class="d-flex align-items-center mb-4">
                <span class="badge badge-circle badge-info me-3">1</span>
                <h4 class="mb-0 text-gray-800 fw-bold">
                  {{ lang === 'ar' ? 'اختر نوع الدفع' : 'Select Payment Type' }}
                </h4>
              </div>
              <p class="text-muted mb-4">
                {{ lang === 'ar' ? 'اختر طريقة الدفع المفضلة لديك' : 'Choose your preferred payment method' }}
              </p>
              
              <div class="row">
                <div class="col-lg-6 mb-4" *ngFor="let type of paymentTypes">
                  <div class="position-relative">
                    <input 
                      name="paymentType"
                      type="radio"
                      class="btn-check"
                      [id]="type.id"
                      [value]="type.id"
                      [checked]="selectedPaymentType === type.id"
                      [disabled]="(type.id === 'manual' && existingManualAccount?.status === 'active') || (type.id === 'provider' && existingProviderAccount && existingProviderAccount.details_submitted_at !== null)" 
                      (change)="onPaymentTypeChange(type.id)"
                    />
                    <label
                      class="btn btn-outline btn-outline-dashed btn-outline-default p-7 d-flex align-items-center position-relative hover-elevate-up shadow-sm rounded-3 transition"
                      [for]="((type.id === 'manual' && existingManualAccount?.status === 'active') || (type.id === 'provider' && existingProviderAccount && existingProviderAccount.details_submitted_at !== null)) ? null : type.id"
                      [class.disabled]="(type.id === 'manual' && existingManualAccount?.status === 'active') || (type.id === 'provider' && existingProviderAccount && existingProviderAccount.details_submitted_at !== null)"
                      [style.cursor]="((type.id === 'manual' && existingManualAccount?.status === 'active') || (type.id === 'provider' && existingProviderAccount && existingProviderAccount.details_submitted_at !== null)) ? 'not-allowed' : 'pointer'"
                      style="height: 140px;"
                    >
                   
                      <!-- Payment type icon -->
                      <div class="mx-5 my-5">
                        <img [src]="type.imageUrl" alt="Payment method icon" style="width: 38px; height: 38px; object-fit: contain;" />
                      </div>
                      
                      <span class="d-block fw-bold text-inline-start">
                        <span class="text-gray-900 fw-bolder d-block fs-4 mb-2">
                          {{ lang === 'ar' ? type.name.ar : type.name.en }}
                        </span>
                        <span class="text-gray-500 fw-bold fs-6">
                          <span *ngIf="!((type.id === 'manual' && existingManualAccount?.status === 'active') || (type.id === 'provider' && existingProviderAccount && existingProviderAccount.details_submitted_at !== null))">
                            {{ lang === 'ar' ? type.description.ar : type.description.en }}
                          </span>
                          <span *ngIf="(type.id === 'manual' && existingManualAccount?.status === 'active') || (type.id === 'provider' && existingProviderAccount && existingProviderAccount.details_submitted_at !== null)" class="text-info">
                            {{ lang === 'ar' ? 'الحساب موجود بالفعل' : 'Account Already Exist' }}
                          </span>
                        </span>
                      </span>
                    </label>

                  </div>
                </div>
              </div>
              
              <!-- Validation error for payment type -->
              <div 
                *ngIf="showValidationErrors && !selectedPaymentType" 
                class="text-danger mt-3 fs-7 d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ lang === 'ar' ? 'يرجى اختيار نوع الدفع' : 'Please select a payment type' }}
              </div>
            </div>
    
            <!-- Step 2: Country Selection (Only for Provider) -->
            <div class="mb-8" *ngIf="selectedPaymentType === 'provider'">
              <div class="d-flex align-items-center mb-4">
                <span class="badge badge-circle badge-info me-3">2</span>
                <h4 class="mb-0 text-gray-800 fw-bold">
                  {{ lang === 'ar' ? 'اختر البلد' : 'Select Country' }}
                </h4>
              </div>
              <p class="text-muted mb-4">
                {{ lang === 'ar' ? 'اختر البلد لحساب Stripe الخاص بك' : 'Select the country for your Stripe account' }}
              </p>

              <!-- Country Selection -->
              <div class="form-group">
                <label class="form-label required">
                  {{ lang === 'ar' ? 'البلد' : 'Country' }}
                </label>
                
                <!-- Selected Country Display -->
                <div *ngIf="selectedCountry" class="selected-country-card mb-3">
                  <div class="card border-info">
                    <div class="card-body p-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                          <img 
                            [src]="getFlagUrl(selectedCountry.flag)" 
                            alt="{{ selectedCountry.name }}" 
                            class="me-3"
                            style="width: 24px; height: 16px; object-fit: cover;">
                          <span class="fw-semibold">{{ selectedCountry.name }}</span>
                        </div>
                        <button 
                          type="button" 
                          class="btn btn-sm btn-light-danger"
                          (click)="unselectCountry()">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Country Search and List -->
                <div *ngIf="!selectedCountry">
                  <div class="input-group mb-3">
                    <span class="input-group-text">
                      <i class="fas fa-search"></i>
                    </span>
                    <input 
                      type="text" 
                      class="form-control" 
                      [(ngModel)]="searchTerm"
                      [ngModelOptions]="{standalone: true}"
                      (ngModelChange)="filterCountries()"
                      [placeholder]="lang === 'ar' ? 'ابحث عن بلد...' : 'Search for a country...'">
                  </div>

                  <div class="country-list" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                    <div 
                      *ngFor="let country of filteredCountries" 
                      class="country-item p-3 hover-light-info cursor-pointer border-bottom"
                      (click)="selectCountry(country)">
                      <div class="d-flex align-items-center">
                        <img 
                          [src]="getFlagUrl(country.flag)" 
                          alt="{{ country.name }}" 
                          class="me-3"
                          style="width: 24px; height: 16px; object-fit: cover;"
                          *ngIf="country.showFlag">
                        <span>{{ country.name }}</span>
                      </div>
                    </div>
                    <div *ngIf="filteredCountries.length === 0" class="p-3 text-center text-muted">
                      {{ lang === 'ar' ? 'لم يتم العثور على بلدان' : 'No countries found' }}
                    </div>
                  </div>
                </div>
                
                <!-- Validation error for country -->
                <div 
                  *ngIf="showValidationErrors && !selectedCountry && selectedPaymentType === 'provider'" 
                  class="text-danger mt-2 fs-7 d-flex align-items-center">
                  <i class="fas fa-exclamation-circle me-2"></i>
                  {{ lang === 'ar' ? 'يرجى اختيار البلد' : 'Please select a country' }}
                </div>
              </div>
            </div>

            <!-- Terms & Conditions Agreement (Only for Stripe Provider) -->
            <div class="mb-4" *ngIf="selectedPaymentType === 'provider'">
              <div class="form-check d-flex align-items-start">
                <input 
                  class="form-check-input me-3 mt-1" 
                  type="checkbox" 
                  id="termsAgreement"
                  formControlName="termsAgreed"
                  (change)="onTermsChange($event)">
                <label class="form-check-label" for="termsAgreement">
                  <span *ngIf="lang === 'ar'">
                    أوافق على إنشاء حساب دفع وأقرّ أني قرأت وفهمت 
                    <a href="javascript:void(0)" 
                       class="text-decoration-underline fw-bold text-info" 
                       (click)="openTermsDialog()">شروط وأحكام الاتفاقية</a>.
                  </span>
                  <span *ngIf="lang !== 'ar'">
                    I agree to create a Payment Account and acknowledge that I have read and understood the 
                    <a href="javascript:void(0)" 
                       class="text-decoration-underline fw-bold text-info" 
                       (click)="openTermsDialog()">Terms & Conditions</a>.
                  </span>
                </label>
              </div>
              
              <!-- Validation error for terms agreement -->
              <div 
                *ngIf="showValidationErrors && paymentForm.get('termsAgreed')?.invalid" 
                class="text-danger mt-2 fs-7 d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ lang === 'ar' ? 'يجب الموافقة على شروط وأحكام الاتفاقية' : 'You must agree to the Terms & Conditions' }}
              </div>
            </div>

          <!-- All Options Exist Message -->
          <div class="card-footer" *ngIf="allPaymentOptionsExist">
            <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
              <i class="fas fa-info-circle me-3 fs-4"></i>
              <div>
                <h6 class="mb-1 fw-bold">
                  {{ lang === 'ar' ? 'جميع طرق الدفع متوفرة' : 'All Payment Options Available' }}
                </h6>
                <p class="mb-0">
                  <span *ngIf="lang === 'ar'">
                    لديك بالفعل جميع طرق الدفع المتاحة. يمكنك حذف أو تعديل طرق الدفع من 
                    <a [routerLink]="['/app/insighter-dashboard/account-settings/payment-settings']" class="text-decoration-underline fw-bold text-info">
                      صفحة إعدادات الدفع
                    </a>.
                  </span>
                  <span *ngIf="lang !== 'ar'">
                    You already have all available payment options. You can delete or edit payment methods from the 
                    <a [routerLink]="['/app/insighter-dashboard/account-settings/payment-settings']" class="text-decoration-underline fw-bold text-info">
                      payment settings page
                    </a>.
                  </span>
                </p>
              </div>
            </div>
          </div>

          <!-- Footer with Next Button -->
          <div class="card-footer" *ngIf="!allPaymentOptionsExist">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">
                <i class="fas fa-shield-alt text-info me-1"></i>
                {{ lang === 'ar' ? 'معلوماتك آمنة ومشفرة' : 'Your information is secure and encrypted' }}
              </div>
              <button 
                type="button"
                class="btn btn-info"
                [disabled]="(paymentService.isLoading$ | async) || isCreatingStripeAccount"
                (click)="onNext()">
                
                <span 
                  *ngIf="(paymentService.isLoading$ | async) || isCreatingStripeAccount"
                  class="spinner-border spinner-border-sm text-white me-2" 
                  role="status" 
                  aria-hidden="true"
                  style="width: 1rem; height: 1rem;">
                </span>
                
                <span *ngIf="!isCreatingStripeAccount">
                  {{ lang === 'ar' ? 'التالي' : 'Next' }}
                </span>
                
                <span *ngIf="isCreatingStripeAccount">
                  {{ lang === 'ar' ? 'جاري إنشاء حساب Stripe...' : 'Creating Stripe account...' }}
                </span>
              </button>
            </div>
          </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Terms & Conditions Dialog -->
  <p-dialog 
    [(visible)]="showTermsDialog" 
    [modal]="true" 
    [closable]="true" 
    [draggable]="false" 
    [resizable]="false"
    [style]="{width: '90vw', maxWidth: '800px'}">
    
    <ng-template pTemplate="header">
      <div class="d-flex justify-content-between align-items-center w-100">
        <h5 class="m-0">{{ lang === 'ar' ? 'شروط وأحكام الاتفاقية' : 'Terms & Conditions' }}</h5>
        <div class="d-flex">
          <button class="btn btn-sm btn-icon me-2" (click)="printTerms()">
            <i class="ki-outline ki-printer fs-3"></i>
          </button>
          <button class="btn btn-sm btn-icon" (click)="saveTerms()">
            <i class="ki-outline ki-save-2 fs-3"></i>
          </button>
        </div>
      </div>
    </ng-template>

    <div class="terms-content" style="max-height: 60vh; overflow-y: auto;">
      <div *ngIf="isLoadingTerms" class="text-center py-4">
        <div class="spinner-border text-info" role="status">
          <span class="visually-hidden">{{ lang === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</span>
        </div>
      </div>
      
      <div *ngIf="!isLoadingTerms && stripeTermsContent" [innerHTML]="stripeTermsContent"></div>
      
      <div *ngIf="!isLoadingTerms && !stripeTermsContent" class="text-center py-4 text-muted">
        <i class="fas fa-exclamation-triangle fs-2x mb-3"></i>
        <p>{{ lang === 'ar' ? 'لا يمكن تحميل الشروط والأحكام' : 'Unable to load Terms & Conditions' }}</p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="d-flex justify-content-end gap-3">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="declineTerms()">
          {{ lang === 'ar' ? 'رفض' : 'Decline' }}
        </button>
        <button 
          type="button" 
          class="btn btn-info"
          (click)="acceptTerms()">
          {{ lang === 'ar' ? 'قبول' : 'Accept' }}
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- OTP Verification Dialog -->
  <p-dialog 
    [(visible)]="showOtpDialog" 
    [modal]="true" 
    [closable]="true" 
    [draggable]="false" 
    [resizable]="false"
    [style]="{width: '90vw', maxWidth: '500px'}"
    header="{{ lang === 'ar' ? 'تحقق من هويتك' : 'Verify Your Identity' }}">

    <div class="otp-content">
      <!-- Redirect Loader -->
      <div *ngIf="isWaitingForRedirect" class="text-center py-5">
        <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3">
          <h5 class="text-gray-700">
            {{ lang === 'ar' ? 'جاري التوجيه إلى Stripe...' : 'Redirecting to Stripe...' }}
          </h5>
          <p class="text-muted">
            {{ lang === 'ar' ? 'يرجى الانتظار' : 'Please wait' }}
          </p>
        </div>
      </div>

      <!-- OTP Form (hidden when redirecting) -->
      <div *ngIf="!isWaitingForRedirect">
        <div class="text-center mb-4">
          <i class="fas fa-shield-check text-info fs-2 mb-3"></i>
          <h5 class="mb-2">
            {{ lang === 'ar' ? 'أدخل رمز التحقق' : 'Enter Verification Code' }}
          </h5>
          <p class="text-muted">
            {{ lang === 'ar' ? 'لقد أرسلنا رمز التحقق إلى بريدك الإلكتروني' : 'We sent a verification code to your email' }}
          </p>
        </div>

        <div class="mb-4">
          <label class="form-label required">
            {{ lang === 'ar' ? 'رمز التحقق' : 'Verification Code' }}
          </label>
          <input
            type="text"
            class="form-control text-center"
            [(ngModel)]="otpCode"
            [ngModelOptions]="{standalone: true}"
            [placeholder]="lang === 'ar' ? 'أدخل الرمز' : 'Enter code'"
            maxlength="10"
            [disabled]="isSubmittingOtp"
          />
          <div class="form-text text-muted mt-2">
            <i class="fas fa-envelope me-1"></i>
            {{ lang === 'ar' ? 'تحقق من بريدك الإلكتروني ومجلد الرسائل المزعجة (تنتهي فعالية الكود في 1 ساعة)' : 'Check your email and spam folder (Code expires in 1 hour)' }}
          </div>
        </div>

        <div class="text-center mb-3">
          <span 
            *ngIf="canResendOtp && !isResendingOtp"
            class="text-info text-decoration-underline"
            style="cursor: pointer;"
            (click)="resendOtp()"
          >
            <i class="fas fa-paper-plane me-1"></i>
            {{ lang === 'ar' ? 'إعادة إرسال الرمز' : 'Resend Code' }}
          </span>
          <span 
            *ngIf="isResendingOtp"
            class="text-info"
          >
            <span 
              class="spinner-border spinner-border-sm me-2" 
              role="status" 
              aria-hidden="true">
            </span>
            {{ lang === 'ar' ? 'جاري الإرسال...' : 'Sending...' }}
          </span>
          <span 
            *ngIf="!canResendOtp && !isResendingOtp"
            class="text-muted"
          >
            <i class="fas fa-clock me-1"></i>
            {{ lang === 'ar' ? 'إعادة الإرسال متاحة خلال' : 'Resend available in' }} {{ resendCooldown }}{{ lang === 'ar' ? 'ث' : 's' }}
          </span>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="d-flex justify-content-between" *ngIf="!isWaitingForRedirect">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="closeOtpDialog()">
          {{ lang === 'ar' ? 'إلغاء' : 'Cancel' }}
        </button>
        <button 
          type="button" 
          class="btn btn-info"
          [disabled]="isSubmittingOtp || !otpCode.trim()"
          (click)="submitOtp()">
          
          <span 
            *ngIf="isSubmittingOtp"
            class="spinner-border spinner-border-sm me-2" 
            role="status" 
            aria-hidden="true">
          </span>
          
          {{ lang === 'ar' ? 'تأكيد' : 'Verify' }}
        </button>
      </div>
    </ng-template>
  </p-dialog>